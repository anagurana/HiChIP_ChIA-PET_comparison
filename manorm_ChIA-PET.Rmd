# Function that updates and sources the function file
```{r}
upd_functions=function(){
  source("functions_ChIA-PET_HiChIP_YRB.R")
}
```

# Generation of BED files (peaks and bins) for the manorm_utils

```{r}

trios=c("GM19238", "GM19239", "GM19240")

### ChIA-PET ###
# Converting peaks.gr into peaks.bed 
# (assumption) peaks are collected in the GRangesList

for (cell_line in cell_lines){
  write.table(unname(data.frame(seqnames(peaks_with_motif_ChIAPET[[cell_line]]), 
                                start(peaks_with_motif_ChIAPET[[cell_line]]), 
                                end(peaks_with_motif_ChIAPET[[cell_line]]))),
              paste0(abs_path, "/chiapet/", "/peaks_ChIAPET_", cell_line, ".bed"),
              sep="\t",row.names=FALSE, quote = FALSE)
}

#Generation of bins file
chiapet_bins=IRanges::reduce(unlist(peaks_with_motif_ChIAPET, recursive = TRUE, use.names = TRUE))
write.table(unname(data.frame(seqnames(chiapet_bins),
                              start(chiapet_bins),
                              end(chiapet_bins))),
            paste0(abs_path, "/chiapet/bins_ChIAPET.bed"),
            sep="\t",row.names=FALSE, quote = FALSE)
# After that bash script is being launched, which takes as the input bed files of peaks, bams and bins (7 files in total for the 3 cell lines)
```

# [ChIA-PET merged] MANorm input
```{r}
experiment="chiapet"
trios=c("GM19238", "GM19239", "GM19240")
norm_inp_chiapet=data.frame(read.table(paste0(abs_path, "/", experiment, "/chiapet_merged_profile_bins.xls"), header = T))

# See how many TRUE/FALSE peaks are present for each cell line for the occupancy calculated by MANorms
table_chiapet_occupancy_raw=list(
  summary(as.logical(norm_inp_chiapet$GM19238.occupancy)),
  summary(as.logical(norm_inp_chiapet$GM19239.occupancy)),
  summary(as.logical(norm_inp_chiapet$GM19240.occupancy)))
names(table_chiapet_occupancy_raw)=trios

# Replace the occupancy by occupancy calculated from overlapping with bins
occupancy_by_overlaps_chiapet=list()
for (cell_line in trios){
  occupancy_by_overlaps_chiapet[[cell_line]]=as.integer(1:NROW(chiapet_bins) %in% unique(queryHits(findOverlaps(chiapet_bins,peaks_with_motif_ChIAPET[[cell_line]]))))
}

norm_inp_chiapet$GM19238.occupancy=occupancy_by_overlaps_chiapet$GM19238
norm_inp_chiapet$GM19239.occupancy=occupancy_by_overlaps_chiapet$GM19239
norm_inp_chiapet$GM19240.occupancy=occupancy_by_overlaps_chiapet$GM19240

# See how many TRUE/FALSE peaks are present for each cell line for the occupancy calculated by overlapping
table_chiapet_occupancy_overlapped=list(
  summary(as.logical(norm_inp_chiapet$GM19238.occupancy)),
  summary(as.logical(norm_inp_chiapet$GM19239.occupancy)),
  summary(as.logical(norm_inp_chiapet$GM19240.occupancy)))
names(table_chiapet_occupancy_overlapped)=trios

```

# [ChIA-PET merged] MANorm normalization

```{r}
### Visualize the plots before/after normalization (Generating new plots and data (log2))
raw_chiapet = log(norm_inp_chiapet[4:6] + 0.5, base = 2)

### Normalization between the cell lines
autosome <- !(norm_inp_chiapet$chrom %in% c("chrX", "chrY"))
norm_chiapet <- normalize(norm_inp_chiapet, c(4:6), c(7:9), common.peak.regions = autosome)

png(paste0('plots/',experiment,'_MAnorm_merRep_normalization.png'), res = 300, width = 4200, height = 4200)

# Generation of new plots before/after normalization (log2)
set_ylim<<-c(-2,2)
par(mar=c(3,3,3,3))
layout(matrix(c(1,2,3,4,5,6,1,7,3,8,5,9),ncol=2),heights=c(1,3,1,3,1,3))
plot.new()
text(0.5,0.5,paste0(trios[1],' vs. ', trios[2]),cex=3,font=2)
generate_manorm_plot(trios[1:2], norm_chiapet, raw_chiapet)
plot.new()
text(0.5,0.5,paste0(trios[1],' vs. ', trios[3]),cex=3,font=2)
generate_manorm_plot(trios[c(1,3)], norm_chiapet, raw_chiapet)
plot.new()
text(0.5,0.5,paste0(trios[2],' vs. ', trios[3]),cex=3,font=2)
generate_manorm_plot(trios[2:3], norm_chiapet , raw_chiapet)

#After normalization
generate_manorm_plot(trios[1:2], norm_chiapet)
generate_manorm_plot(trios[c(1,3)], norm_chiapet)
generate_manorm_plot(trios[2:3], norm_chiapet)
dev.off()

```

# [ChIA-PET merged] Modeling of Mean-Variance Trend

```{r}

### Construct a bioCond for each group of the samples.
conds_chiapet <- list(
  bioCond(norm_chiapet[4], norm_chiapet[7], name = trios[1]),
  bioCond(norm_chiapet[5], norm_chiapet[8], name = trios[2]),
  bioCond(norm_chiapet[6], norm_chiapet[9], name = trios[3]))
names(conds_chiapet)=trios

### Create a "blind" biocond, that will treat two samples as replicates.
# Only common peak regions of the two samples are considered to the occupied by the "Blind" bioCond

conds_chiapet$blind_1 <- bioCond(norm_chiapet[c(4, 5)], norm_chiapet[c(7, 8)], occupy.num = 2)
conds_chiapet$blind_2 <- bioCond(norm_chiapet[c(4, 6)], norm_chiapet[c(7, 9)], occupy.num = 2)
conds_chiapet$blind_3 <- bioCond(norm_chiapet[c(5, 6)], norm_chiapet[c(8, 9)], occupy.num = 2)
conds_chiapet$blind_common <- bioCond(norm_chiapet[c(4, 5, 6)], norm_chiapet[c(7, 8, 9)], occupy.num = 3)

names(conds_chiapet)[4:7]=c(paste0("blind_", trios[1],"_",trios[2]), 
                            paste0("blind_", trios[1],"_",trios[3]),
                            paste0("blind_", trios[2],"_",trios[3]),
                            "blind_common")

conds_chiapet_meanCurve=list(fitMeanVarCurve(conds_chiapet[c(1, 2, 3, 7)], method = "parametric",
                                             occupy.only = TRUE, init.coef = c(0.1, 10)),
                             fitMeanVarCurve(conds_chiapet[c(1, 2, 4)], method = "parametric",
                                             occupy.only = TRUE, init.coef = c(0.1, 10)),
                             fitMeanVarCurve(conds_chiapet[c(1, 3, 5)], method = "parametric",
                                             occupy.only = TRUE, init.coef = c(0.1, 10)),
                             fitMeanVarCurve(conds_chiapet[c(2, 3, 6)], method = "parametric",
                                             occupy.only = TRUE, init.coef = c(0.1, 10)))
names(conds_chiapet_meanCurve)=c("all_trios", 
                                 paste0(trios[1],"_",trios[2]),
                                 paste0(trios[1],"_",trios[3]), 
                                 paste0(trios[2],"_",trios[3]))

# Visualize mean-variance trend along with the fitted MVC. (Plots are not being saved)
plotMeanVarCurve(conds_chiapet_meanCurve[[2]][3], subset = "occupied", ylim = c(-7, 1))
plotMeanVarCurve(conds_chiapet_meanCurve[[3]][3], subset = "occupied", ylim = c(-7, 1))
plotMeanVarCurve(conds_chiapet_meanCurve[[4]][3], subset = "occupied", ylim = c(-7, 1))
plotMeanVarCurve(conds_chiapet_meanCurve$all_trios[4], subset = "occupied", ylim = c(-7, 1))

```

# [ChIA-PET merged] Differential Tests

```{r}

### # Perform differential tests
res_chiapet=list(
  aovBioCond(conds_chiapet_meanCurve[[1]]),
  diffTest(conds_chiapet_meanCurve[[2]][[1]], conds_chiapet_meanCurve[[2]][[2]]),
  diffTest(conds_chiapet_meanCurve[[3]][[1]], conds_chiapet_meanCurve[[3]][[2]]),
  diffTest(conds_chiapet_meanCurve[[4]][[1]], conds_chiapet_meanCurve[[4]][[2]]))
names(res_chiapet)=names(conds_chiapet_meanCurve)

# Visualize the results
p_value<<- 0.05

png(paste0('plots/',experiment,'_MAnorm_merRep_trios_diff_test_pval_',p_value,'.png'), res = 300, width = 2200, height = 2200)
par(mar=c(2.3,2.3,2.3,2.3))
layout(matrix(c(1,2,3,4,1,5,3,4,1,6,3,4),ncol=3),heights=c(1,3,1,3,1,3))

plot.new()
text(0.5,0.5,"Within paris of trios ",cex=3,font=2)
MAplot(res_chiapet[[2]], pval = p_value, ylim = c(-2, 2), main=paste0(trios[1]," vs. ",trios[2]), line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
plot.new()
text(0.5,0.5,"Within all trios ",cex=3,font=2)
plot(res_chiapet[[1]], pval = p_value,line=0.2)
MAplot(res_chiapet[[3]], pval = p_value,ylim = c(-2, 2), main=paste0(trios[1]," vs. ",trios[3]), line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
MAplot(res_chiapet[[4]], pval = p_value,ylim = c(-2, 2), main=paste0(trios[2]," vs. ",trios[3]),line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
dev.off()

```

# [ChIA-PET merged] Differential Tests - statistical power of identifying differential genomic intervals for merged and single replicates

```{r}

#Define the correlation between single and merged replicates
correaltion_chiapet_mer_vs_2rep=c()
for (name in names(res_chiapet)){
  correaltion_chiapet_mer_vs_2rep[[name]]=cor(res_chiapet_rep2[[name]]$pval, res_chiapet[[name]]$pval, method = "spearman")
}

png(paste0('plots/',experiment,'_correlation_pval_single_merged.png'), res = 300, width = 2200, height = 1100)
layout(matrix(c(1,3,7,2,4,8,2,5,9,2,6,10),ncol=4),heights=c(1,3,0.5,1,3,0.5,1,3,0.5,1,3,0.5), widths=c(2, 1.5, 1.5, 1.5))

par(mar=c(0,0,0,0))
plot.new()
text(0.5,0.5,"All trios",cex=1.5,font=2)
plot.new()
text(0.5,0.5,"Within pairs of trios",cex=1.5,font=2)

par(mar=c(4,4,1,0.5))
plot(-log10(res_chiapet_rep2[[1]]$pval), -log10(res_chiapet[[1]]$pval), col = "#0000FF14", pch = 20, xlab = "With Reps", ylab = "Without Reps")
plot(-log10(res_chiapet_rep2[[2]]$pval), -log10(res_chiapet[[2]]$pval), col = "#0000FF14", pch = 20, xlab = "With Reps", ylab = "Without Reps", main=names(res_chiapet_rep2)[[2]])
plot(-log10(res_chiapet_rep2[[3]]$pval), -log10(res_chiapet[[3]]$pval), col = "#0000FF14", pch = 20, xlab = "With Reps", ylab = "Without Reps", main=names(res_chiapet_rep2)[[3]])
plot(-log10(res_chiapet_rep2[[4]]$pval), -log10(res_chiapet[[4]]$pval), col = "#0000FF14", pch = 20, xlab = "With Reps", ylab = "Without Reps", main=names(res_chiapet_rep2)[[4]])

par(mar=c(0,0,0,0))
plot.new()
text(0.66, 0.66,paste0("cor = ",round(correaltion_chiapet_mer_vs_2rep[[1]],2)),cex=1,font=2)
plot.new()
text(0.66, 0.66,paste0("cor = ",round(correaltion_chiapet_mer_vs_2rep[[2]],2)),cex=1,font=2)
plot.new()
text(0.66, 0.66,paste0("cor = ",round(correaltion_chiapet_mer_vs_2rep[[3]],2)),cex=1,font=2)
plot.new()
text(0.66, 0.66,paste0("cor = ",round(correaltion_chiapet_mer_vs_2rep[[4]],2)),cex=1,font=2)

```

# [ChIA-PET merged] Analysis of the results: variable and constant peaks

```{r}
experiment="ChIA-PET"

# Create tables that will include all important information for the analysis
common_chiapet_manorm=list(
  create_table_common_peaks_with_info(norm_chiapet, res_chiapet, conds_chiapet, trios[1:2]),
  create_table_common_peaks_with_info(norm_chiapet, res_chiapet, conds_chiapet,trios[c(1,3)]),
  create_table_common_peaks_with_info(norm_chiapet, res_chiapet, conds_chiapet, trios[2:3]))
names(common_chiapet_manorm)=create_short_name_for_col(trios)

# Create additional tables with lower and higher values of mean values (select the squares)
mean_cutoff=10

common_chiapet_manorm=add_greater_and_lower_mean_ranges_tables(common_chiapet_manorm, mean_cutoff, trios[1:2])
common_chiapet_manorm=add_greater_and_lower_mean_ranges_tables(common_chiapet_manorm, mean_cutoff, trios[c(1,3)])
common_chiapet_manorm=add_greater_and_lower_mean_ranges_tables(common_chiapet_manorm, mean_cutoff, trios[2:3])

# Create false pos tables
par="isPval"

pos_false_tables_chiapet=list(
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[1]],trios[1:2], experiment, "all_mrgRep", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[4]],trios[1:2], experiment, "mean>=10_mrgRep", par),      
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[5]],trios[1:2], experiment, "mean<10_mrgRep", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[2]],trios[c(1,3)], experiment, "all_mrgBins", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[6]],trios[c(1,3)], experiment, "mean>=10_mrgRep", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[7]],trios[c(1,3)], experiment, "mean<10_mrgRep", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[3]],trios[2:3], experiment, "all_mrgRep", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[8]],trios[2:3], experiment, "mean>=10_mrgRep", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[9]],trios[2:3], experiment, "mean<10_mrgRep", par))

names(pos_false_tables_chiapet)=names(common_chiapet_manorm)[c(1,4,5,2,6,7,3,8,9)]

```

[ChIA-PET merged] Confusion tables and data

```{r}

# Create confusion tables for every pairs of replicates and greater and lower ranges                  
confusion_tables_chiapet=vector(mode="list", length=NROW(pos_false_tables_chiapet))
names(confusion_tables_chiapet)=names(pos_false_tables_chiapet)

for (i in 1:NROW(confusion_tables_chiapet)){
  confusion_tables_chiapet[i]=list(caret::confusionMatrix(factor(common_chiapet_manorm[[names(confusion_tables_chiapet)[i]]]$common_pval, levels=c(TRUE, FALSE)), 
                                                          factor(common_chiapet_manorm[[names(confusion_tables_chiapet)[i]]]$predicted_rev, levels=c(TRUE, FALSE)),
                                                          dnn=c("pval>0.05", "SPP_detected")))
}


# Table that are laying below the confusion matrix
# 4 CASES
confusion_data_chiapet=list(
  # Both show common (TP)
  list(TP=pos_false_tables_chiapet[[1]][[1]][pos_false_tables_chiapet[[1]][[1]]$common_pval==TRUE,],
       # Spp shows yes, but pval shows different strength (FP)
       FP=pos_false_tables_chiapet[[1]][[1]][pos_false_tables_chiapet[[1]][[1]]$common_pval==FALSE,], 
       # SPP shows no, but pval shows, że siła jest taka sama (FN)
       FN=pos_false_tables_chiapet[[1]][["false_peaks"]][pos_false_tables_chiapet[[1]][["false_peaks"]]$common_pval==TRUE,],
       # SPP pokazuje nie i pval się zgadza  (TN)
       TN=pos_false_tables_chiapet[[1]][["false_peaks"]][pos_false_tables_chiapet[[1]][["false_peaks"]]$common_pval==FALSE,]),
  list(TP=pos_false_tables_chiapet[[4]][[1]][pos_false_tables_chiapet[[4]][[1]]$common_pval==TRUE,],
       
       # Spp pokazuje tak, a pval pokazuje róźną siłę (FP)
       FP=pos_false_tables_chiapet[[4]][[1]][pos_false_tables_chiapet[[4]][[1]]$common_pval==FALSE,],
       # SPP pokazuje nie, a pval pokazuje, że siła jest taka sama (FN)
       FN=pos_false_tables_chiapet[[4]][["false_peaks"]][pos_false_tables_chiapet[[4]][["false_peaks"]]$common_pval==TRUE,],
       # SPP pokazuje nie i pval się zgadza  (TN)
       TN=pos_false_tables_chiapet[[4]][["false_peaks"]][pos_false_tables_chiapet[[4]][["false_peaks"]]$common_pval==FALSE,]),
  
  list(TP=pos_false_tables_chiapet[[7]][[1]][pos_false_tables_chiapet[[7]][[1]]$common_pval==TRUE,],
       # Spp pokazuje tak, a pval pokazuje róźną siłę (FP)
       FP=pos_false_tables_chiapet[[7]][[1]][pos_false_tables_chiapet[[7]][[1]]$common_pval==FALSE,],
       # SPP pokazuje nie, a pval pokazuje, że siła jest taka sama (FN)
       FN=pos_false_tables_chiapet[[7]][["false_peaks"]][pos_false_tables_chiapet[[7]][["false_peaks"]]$common_pval==TRUE,],
       # SPP pokazuje nie i pval się zgadza  (TN)
       TN=pos_false_tables_chiapet[[7]][["false_peaks"]][pos_false_tables_chiapet[[7]][["false_peaks"]]$common_pval==FALSE,]))

names(confusion_data_chiapet)=names(common_chiapet_manorm)[1:3]