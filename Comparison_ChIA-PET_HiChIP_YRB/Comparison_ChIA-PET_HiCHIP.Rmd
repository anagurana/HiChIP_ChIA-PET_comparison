---
title: "Comparison of ChIA-PET and HiChIP technologies"
---
"
In this script there will be main techniques for comparison of the ChIA-PET and HiChIP data.
All the important functions could be found in functions....R script
"
--- 

# Specify the path where the replicates are being places
"
Script is assuming that there are 3 folders inside of the abs_path directory: ChIA-PET, HiChIP and ChiP-Seq
Inside of each directory there is a folder, that contain the run names
"

```{r}
upd_functions=function(){
  source("functions_ChIA-PET_HiChIP_YRB.R")
}
```

# Read CTCF motif file
```{r}
# Read CTCF motif peaks
CTCF.hg38 = read.table(file.path("data/CTCF_hg38.txt"))
CTCF.hg38 = GRanges(seqnames = CTCF.hg38$V1, IRanges(start = CTCF.hg38$V3, width = CTCF.hg38$V4), strand = ifelse(CTCF.hg38$V5=='p', "+", "-"), score=CTCF.hg38$V6)
CTCF.hg38 = CTCF.hg38[CTCF.hg38$score >0]
```
# Upload of the peaks data
```{r}
cell_lines=c("GM19238", "GM19239", "GM19240")

experiment_1<<-"chiapet"
experiment_2<<-"hichip"
experiment_3<<-"chipseq"

#peaks_extension
p_exp<<-1000

peaks_raw_ChIAPET=GRangesList("GM19238"=GRanges(), "GM19239"=GRanges(), "GM19240"=GRanges())
peaks_raw_HiChIP=GRangesList("GM19238"=GRanges(), "GM19239"=GRanges(), "GM19240"=GRanges())
peaks_raw_ChIPSeq=GRangesList("GM19238"=GRanges(), "GM19239"=GRanges(), "GM19240"=GRanges())

peaks_wout_sex_chr_ChIAPET=peaks_with_motif_ChIAPET=peaks_reduced_with_motif_ChIAPET=peaks_raw_ChIAPET
peaks_wout_sex_chr_HiChIP=peaks_with_motif_HiChIP=peaks_reduced_with_motif_HiChIP=peaks_raw_HiChIP
peaks_wout_sex_chr_ChIPSeq=peaks_with_motif_ChIPSeq=peaks_reduced_with_motif_ChIPSeq=peaks_raw_ChIPSeq

#Create GRangesLists that will conclude all the trios data

for (cell_line in cell_lines){
  
  peaks_raw_ChIAPET[[cell_line]]=read_peaks(get_peaks_path(experiment_1, cell_line))
  peaks_raw_HiChIP[[cell_line]]=read_peaks(get_peaks_path(experiment_2, cell_line))
  peaks_raw_ChIPSeq[[cell_line]]=read_peaks(get_peaks_path(experiment_3, cell_line))
  
  peaks_with_motif_ChIAPET[[cell_line]]=peaks_raw_ChIAPET[[cell_line]][unique(queryHits(findOverlaps(IRanges::reduce(peaks_raw_ChIAPET[[cell_line]]), IRanges::reduce(CTCF.hg38))))]
  peaks_with_motif_HiChIP[[cell_line]]=peaks_raw_HiChIP[[cell_line]][unique(queryHits(findOverlaps(IRanges::reduce(peaks_raw_HiChIP[[cell_line]]), IRanges::reduce(CTCF.hg38))))]
  peaks_with_motif_ChIPSeq[[cell_line]]=peaks_raw_ChIPSeq[[cell_line]][unique(queryHits(findOverlaps(IRanges::reduce(peaks_raw_ChIPSeq[[cell_line]]), IRanges::reduce(CTCF.hg38))))]
  
  peaks_reduced_with_motif_ChIAPET[[cell_line]]=IRanges::reduce(peaks_with_motif_ChIAPET[[cell_line]]+p_exp)
  peaks_reduced_with_motif_HiChIP[[cell_line]]=IRanges::reduce(peaks_with_motif_HiChIP[[cell_line]]+p_exp)
  peaks_reduced_with_motif_ChIPSeq[[cell_line]]=IRanges::reduce(peaks_with_motif_ChIPSeq[[cell_line]]+p_exp)
  
  peaks_wout_sex_chr_ChIAPET[[cell_line]]=subset(
    peaks_with_motif_ChIAPET[[cell_line]],
    !(peaks_with_motif_ChIAPET[[cell_line]]@seqnames %in% c('chrY', 'chrX', 'chrM')))
  peaks_wout_sex_chr_HiChIP[[cell_line]]=subset(
    peaks_with_motif_HiChIP[[cell_line]],
    !(peaks_with_motif_HiChIP[[cell_line]]@seqnames %in% c('chrY', 'chrX', 'chrM')))
  peaks_wout_sex_chr_ChIPSeq[[cell_line]]=subset(
    peaks_with_motif_ChIPSeq[[cell_line]],
    !(peaks_with_motif_ChIPSeq[[cell_line]]@seqnames %in% c('chrY', 'chrX', 'chrM')))
}

```
# Upload peaks for single replicates 
```{r}
cell_lines=c("GM19238_rep1", "GM19238_rep2", "GM19239_rep1", "GM19239_rep2","GM19240_rep1","GM19240_rep2")

experiment<<-"hichip"

rep2_peaks_raw_HiChIP=GRangesList("GM19238_rep1"=GRanges(), "GM19238_rep2"=GRanges(),
                                  "GM19239_rep1"=GRanges(),"GM19239_rep2"=GRanges(),
                                  "GM19240_rep1"=GRanges(),"GM19240_rep2"=GRanges())

rep2_peaks_wout_sex_chr_HiChIP=rep2_peaks_with_motif_HiChIP=rep2_peaks_reduced_with_motif_HiChIP=rep2_peaks_raw_HiChIP

#Create GRangesLists that will conclude all the trios data

for (cell_line in cell_lines){
  
  rep2_peaks_raw_HiChIP[[cell_line]]=read_peaks(get_peaks_path(experiment, cell_line))
  
  rep2_peaks_with_motif_HiChIP[[cell_line]]=rep2_peaks_raw_HiChIP[[cell_line]][unique(queryHits(findOverlaps(IRanges::reduce(rep2_peaks_raw_HiChIP[[cell_line]]+p_exp), IRanges::reduce(CTCF.hg38+p_exp))))]
  
  rep2_peaks_reduced_with_motif_HiChIP[[cell_line]]=IRanges::reduce(rep2_peaks_with_motif_HiChIP[[cell_line]]+p_exp)
  
  rep2_peaks_wout_sex_chr_HiChIP[[cell_line]]=subset(
    rep2_peaks_with_motif_HiChIP[[cell_line]],
    !(rep2_peaks_with_motif_HiChIP[[cell_line]]@seqnames %in% c('chrY', 'chrX', 'chrM')))
}

experiment<<-"chiapet"
cell_lines=c("GM19238_rep1", "GM19238_rep2", "GM19239_rep1", "GM19239_rep2","GM19240_rep1","GM19240_rep2")

rep2_peaks_raw_ChIAPET=GRangesList("GM19238_rep1"=GRanges(), "GM19238_rep2"=GRanges(),
                                  "GM19239_rep1"=GRanges(),"GM19239_rep2"=GRanges(),
                                  "GM19240_rep1"=GRanges(),"GM19240_rep2"=GRanges())

rep2_peaks_wout_sex_chr_ChIAPET=rep2_peaks_with_motif_ChIAPET=rep2_peaks_reduced_with_motif_ChIAPET=rep2_peaks_raw_ChIAPET

#Create GRangesLists that will conclude all the trios data

for (cell_line in cell_lines){
  
  rep2_peaks_raw_ChIAPET[[cell_line]]=read_peaks(get_peaks_path(experiment, cell_line))
  
  rep2_peaks_with_motif_ChIAPET[[cell_line]]=rep2_peaks_raw_ChIAPET[[cell_line]][unique(queryHits(findOverlaps(IRanges::reduce(rep2_peaks_raw_ChIAPET[[cell_line]]), IRanges::reduce(CTCF.hg38))))]
  
  rep2_peaks_reduced_with_motif_ChIAPET[[cell_line]]=IRanges::reduce(rep2_peaks_with_motif_ChIAPET[[cell_line]]+p_exp)
  
  rep2_peaks_wout_sex_chr_ChIAPET[[cell_line]]=subset(
    rep2_peaks_with_motif_ChIAPET[[cell_line]],
    !(rep2_peaks_with_motif_ChIAPET[[cell_line]]@seqnames %in% c('chrY', 'chrX', 'chrM')))
}
 

```

#Comparison between the replicates for ChIA-PET

```{r}
experiment<<-"chiapet"
cell_lines=c("GM19238", "GM19239", "GM19240")
common_peaks_ChIAPET_replicates=GRangesList("GM19238"=GRanges(), "GM19239"=GRanges(), "GM19240"=GRanges())

experiment_2<<-experiment_1<<-experiment
for (cell_line in cell_lines){
  # Specify the runs' name
  run_1<<-paste0(cell_line, "_rep1")
  run_2<<-paste0(cell_line, "_rep2")
  
  common_peaks_ChIAPET_replicates[[cell_line]] <- subsetByOverlaps(IRanges::reduce(rep2_peaks_raw_ChIAPET[[run_1]]+p_exp), IRanges::reduce(rep2_peaks_raw_ChIAPET[[run_2]]+p_exp))
  
  # Draw the plots
  png(paste0('plots/venn_diagrams/1.Common_peaks_ChIA-PET_', cell_line, '_replicates.png'), res = 300, width = 2400, height = 2400)
  plot.new()
  draw_2_venn_diagram(NROW(IRanges::reduce(rep2_peaks_raw_ChIAPET[[run_1]]+p_exp)), NROW(IRanges::reduce(rep2_peaks_raw_ChIAPET[[run_2]]+p_exp)), NROW(common_peaks_ChIAPET_replicates[[cell_line]]))
  dev.off()
}


experiment_2<<-experiment_1<<-experiment
for (cell_line in cell_lines){
  # Specify the runs' name
  run_1<<-paste0(cell_line, "_rep1")
  run_2<<-paste0(cell_line, "_rep2")
  
  common_peaks_ChIAPET_replicates[[cell_line]] <- subsetByOverlaps(IRanges::reduce(rep2_peaks_with_motif_ChIAPET[[run_1]]+p_exp), IRanges::reduce(rep2_peaks_with_motif_ChIAPET[[run_2]]+p_exp))
  
  # Draw the plots
  png(paste0('plots/venn_diagrams/1.Common_peaks_ChIA-PET_', cell_line, '_replicates.png'), res = 300, width = 2400, height = 2400)
  plot.new()
  draw_2_venn_diagram(NROW(IRanges::reduce(rep2_peaks_raw_ChIAPET[[run_1]]+p_exp)), NROW(IRanges::reduce(rep2_peaks_raw_ChIAPET[[run_2]]+p_exp)), NROW(common_peaks_ChIAPET_replicates[[cell_line]]))
  dev.off()
}




```

# Comparison between the replicates for HiChIP

```{r}
experiment<<-"hichip"
cell_lines=c("GM19238", "GM19239", "GM19240")
common_peaks_HiChIP_replicates=GRangesList("GM19238"=GRanges(), "GM19239"=GRanges(), "GM19240"=GRanges())

experiment_2<<-experiment_1<<-experiment

for (cell_line in cell_lines){
  # Specify the runs' name
  run_1<<-paste0(cell_line, "_rep1")
  run_2<<-paste0(cell_line, "_rep2")

  if (NROW(peaks_hichip_rep1) > NROW(peaks_hichip_rep2)){
    common_peaks_HiChIP_replicates[[cell_line]] <- subsetByOverlaps(IRanges::reduce(rep2_peaks_raw_HiChIP[[run_2]]+p_exp), IRanges::reduce(rep2_peaks_raw_HiChIP[[run_1]]+p_exp))
  } else{
  common_peaks_HiChIP_replicates[[cell_line]] <- subsetByOverlaps(IRanges::reduce(rep2_peaks_raw_HiChIP[[run_1]]+p_exp), IRanges::reduce(rep2_peaks_raw_HiChIP[[run_2]]+p_exp))
  }
  # Draw the plots
  png(paste0('Common_peaks_HiChIP_', cell_line, '_replicates.png'), res = 300, width = 2400, height = 2400)
  plot.new()
  draw_2_venn_diagram(NROW(IRanges::reduce(rep2_peaks_raw_HiChIP[[run_1]]+p_exp)), NROW(IRanges::reduce(rep2_peaks_raw_HiChIP[[run_2]]+p_exp)), NROW(common_peaks_HiChIP_replicates[[cell_line]]))
  dev.off()
}

```

# Comparison between the technologies on the same cell line (x3)
# ec. GM19238 --> ChIAPET, HiChIP and ChIPSeq

```{r}

cell_lines=c("GM19238", "GM19239", "GM19240")

experiment_1<<-"chiapet"
experiment_2<<-"hichip"
experiment_3<<-"chipseq"

for (cell_line in cell_lines){
  
  cell_line_1<<-cell_line_2<<-cell_line_3<<-cell_line
  
  common_peaks=find_main_overlaps_between_3(peaks_raw_ChIAPET[[cell_line]], 
                                            peaks_raw_HiChIP[[cell_line]], 
                                            peaks_raw_ChIPSeq[[cell_line]])
  assign(paste0("common_peaks_", cell_line, "_3_tech"), common_peaks)
  
  
  # Draw and save the plots
  png(paste0('Common_peaks_between_technologies_', cell_line, 
             '_pulled_exp_', p_exp, '.png'), 
      res = 300, width = 4200, height = 4200)
  plot.new()
  draw_3_venn_diagram(NROW(peaks_raw_ChIAPET[[cell_line]]), 
                      NROW(peaks_raw_HiChIP[[cell_line]]), 
                      NROW(peaks_raw_ChIPSeq[[cell_line]]), 
                      common_peaks)
  dev.off()
  
  # Pairwise Venn diagrams
  
  png(paste0('Common_peaks_between_',experiment_1,'_and_',experiment_2,'_',cell_line,'_pulled_exp_',p_exp,'.png'), res = 300, width = 2400, height = 2400)
  plot.new()
  draw_2_venn_diagram(NROW(peaks_raw_ChIAPET[[cell_line]]), 
                      NROW(peaks_raw_HiChIP[[cell_line]]), 
                      NROW(common_peaks$com12), 12)
  dev.off()
  
  png(paste0('Common_peaks_between_',experiment_1,'_and_',experiment_3,'_',cell_line,'_pulled_exp_',p_exp,'.png'), res = 300, width = 2400, height = 2400)
  plot.new()
  draw_2_venn_diagram(NROW(peaks_raw_ChIAPET[[cell_line]]), 
                      NROW(peaks_raw_ChIPSeq[[cell_line]]), 
                      NROW(common_peaks$com13), 13)
  dev.off()
  
  png(paste0('Common_peaks_between_',experiment_2,'_and_',experiment_3,'_',cell_line,'_pulled_exp_',p_exp,'.png'), res = 300, width = 2400, height = 2400)
  plot.new()
  draw_2_venn_diagram(NROW(peaks_raw_HiChIP[[cell_line]]), 
                      NROW(peaks_raw_ChIPSeq[[cell_line]]), 
                      NROW(common_peaks$com23), 23)
  dev.off()
}

rm(common_peaks)

```

# Peaks with CTCF motif, comparison inside of the cell line for every technology(x3)
# # ec. GM19238 --> ChIAPET, HiChIP and ChIPSeq
```{r}
cell_lines=c("GM19238", "GM19239", "GM19240")

experiment_1<<-"chiapet"
experiment_2<<-"hichip"
experiment_3<<-"chipseq"

for (cell_line in cell_lines){
  
  cell_line_1<<-cell_line_2<<-cell_line_3<<-cell_line
  
  common_peaks=find_main_overlaps_between_3(peaks_with_motif_ChIAPET[[cell_line]], 
                                            peaks_with_motif_HiChIP[[cell_line]], 
                                            peaks_with_motif_ChIPSeq[[cell_line]])
  assign(paste0("common_peaks_with_motif_", cell_line, "_3_tech"), common_peaks)
  
  # Draw and save the plots
  png(paste0('Common_peaks_with_motif_between_technologies_', cell_line, '_pulled_exp_', p_exp, '.png'), res = 300, width = 4200, height = 4200)
  plot.new()
  draw_3_venn_diagram(NROW(peaks_with_motif_ChIAPET[[cell_line]]), 
                      NROW(peaks_with_motif_HiChIP[[cell_line]]), 
                      NROW(peaks_with_motif_ChIPSeq[[cell_line]]), 
                      common_peaks)
  dev.off()
  
  # Pairwise Venn diagrams
  
  png(paste0('Common_peaks_with_motif_between_',experiment_1,'_and_',experiment_2,'_',cell_line,'_pulled_exp_',p_exp,'.png'), 
      res = 300, width = 2400, height = 2400)
  plot.new()
  draw_2_venn_diagram(NROW(peaks_with_motif_ChIAPET[[cell_line]]), 
                      NROW(peaks_with_motif_HiChIP[[cell_line]]), 
                      NROW(common_peaks$com12), 12)
  dev.off()
  
  png(paste0('Common_peaks_with_motif_between_',experiment_1,'_and_',experiment_3,'_',cell_line,'_pulled_exp_',p_exp,'.png'), 
      res = 300, width = 2400, height = 2400)
  plot.new()
  draw_2_venn_diagram(NROW(peaks_with_motif_ChIAPET[[cell_line]]), 
                      NROW(peaks_with_motif_ChIPSeq[[cell_line]]), 
                      NROW(common_peaks$com13), 13)
  dev.off()
  
  png(paste0('Common_peaks_with_motif_between_',experiment_2,'_and_',experiment_3,'_',cell_line,'_pulled_exp_',p_exp,'.png'), 
      res = 300, width = 2400, height = 2400)
  plot.new()
  draw_2_venn_diagram(NROW(peaks_with_motif_HiChIP[[cell_line]]), 
                      NROW(peaks_with_motif_ChIPSeq[[cell_line]]), 
                      NROW(common_peaks$com23), 23)
  dev.off()
}

rm(common_peaks)

```

# Comparison between the trios on the same technology (x3)
```{r}
cell_lines<<-c("GM19238", "GM19239", "GM19240")
experiments<<-c("ChIAPET", "HiChIP", "ChIPSeq")

for (experiment in experiments){
  
  experiment_1<<-experiment_2<<-experiment_3<<-experiment
  
  common_peaks=find_main_overlaps_between_3(get(paste0("peaks_wout_sex_chr_", experiment))$GM19238, 
                                            get(paste0("peaks_wout_sex_chr_", experiment))$GM19239, 
                                            get(paste0("peaks_wout_sex_chr_", experiment))$GM19240)
  assign(paste0("common_peaks_for_trios_", experiment), common_peaks)
  
  # Draw and save the plots
  png(paste0('Common_peaks_inside_trios_', experiment, '.png'), res = 300, width = 4200, height = 4200)
  plot.new()
  draw_3_venn_diagram(NROW(get(paste0("peaks_wout_sex_chr_", experiment))$GM19238), 
                      NROW(get(paste0("peaks_wout_sex_chr_", experiment))$GM19239), 
                      NROW(get(paste0("peaks_wout_sex_chr_", experiment))$GM19240), 
                      common_peaks)
  dev.off()
}
rm(common_peaks)


```
# Compare if the peaks between two family members are the same as for the third member
```{r}

experiments=c("ChIAPET", "HiChIP", "ChIPSeq")

for (experiment in experiments){
  
  # between trios or between experiment
  true_common_peaks_experiment=
    find_true_all_relative_overlaps(get(paste0("peaks_wout_sex_chr_", experiment))$GM19238,
                                  get(paste0("peaks_wout_sex_chr_", experiment))$GM19239,
                                  get(paste0("peaks_wout_sex_chr_", experiment))$GM19240,
                                  "trios")
   assign(paste0("true_common_peaks_", experiment), true_common_peaks_experiment)
  
}
rm(true_common_peaks_experiment)

prcntg_common=list(ChIAPET=get_percentg_common_peaks(true_common_peaks_ChIAPET),
                   HiChIP=get_percentg_common_peaks(true_common_peaks_HiChIP),
                   ChIPSeq=get_percentg_common_peaks(true_common_peaks_ChIPSeq))


# Find how many peaks are common with ChIP-Seq 
common_with_ChIPSeq=GRangesList(constant_peaks=GRanges(), common_38_39=GRanges(),
                                common_38_40=GRanges(), common_39_40=GRanges(), 
                                unique_38=GRanges(), unique_39=GRanges(), unique_40=GRanges())

for (experiment in c("ChIAPET", "HiChIP")){
  for (com_groups in names(common_with_ChIPSeq)){
    common_with_ChIPSeq[[com_groups]]=subsetByOverlaps(IRanges::reduce(get(paste0("true_common_peaks_", experiment))[[com_groups]]), 
                   IRanges::reduce(true_common_peaks_ChIPSeq[[com_groups]]))
  }
  assign(paste0("common_with_ChIPSeq___", experiment), common_with_ChIPSeq)
}
rm(common_with_ChIPSeq)

subsetByOverlaps(unlist(true_common_peaks_ChIAPET, recursive = TRUE, use.names = TRUE), unlist(true_common_peaks_ChIPSeq, recursive = TRUE, use.names = TRUE))
chiapet_not_chipseq=subsetByOverlaps(unlist(true_common_peaks_ChIAPET, recursive = TRUE, use.names = TRUE), unlist(true_common_peaks_ChIPSeq, recursive = TRUE, use.names = TRUE), invert=TRUE)
elementNROWS(common_with_ChIPSeq___ChIAPET)

subsetByOverlaps(unlist(true_common_peaks_HiChIP, recursive = TRUE, use.names = TRUE), unlist(true_common_peaks_ChIPSeq, recursive = TRUE, use.names = TRUE))
hichip_not_chipseq=subsetByOverlaps(unlist(true_common_peaks_HiChIP, recursive = TRUE, use.names = TRUE), unlist(true_common_peaks_ChIPSeq, recursive = TRUE, use.names = TRUE), invert=TRUE)
elementNROWS(common_with_ChIPSeq___HiChIP)

```
Do the same with 1kb extension on both sides
```{r}

true_common_peaks_experiment_reduced=GRangesList(constant_peaks=GRanges(), common_38_39=GRanges(),
                                common_38_40=GRanges(), common_39_40=GRanges(), 
                                unique_38=GRanges(), unique_39=GRanges(), unique_40=GRanges())
### Reducing the peaks
for (experiment in experiments){
  for (com_groups in names(true_common_peaks_experiment_reduced))
  true_common_peaks_experiment_reduced[[com_groups]]=
    IRanges::reduce(get(paste0("true_common_peaks_", experiment))[[com_groups]]+p_exp)
  assign(paste0("true_common_peaks_reduced_", experiment), true_common_peaks_experiment_reduced)
}
rm(true_common_peaks_experiment_reduced)

prcntg_common_reduced=list(ChIAPET=get_percentg_common_peaks(true_common_peaks_reduced_ChIAPET),
                   HiChIP=get_percentg_common_peaks(true_common_peaks_reduced_HiChIP),
                   ChIPSeq=get_percentg_common_peaks(true_common_peaks_reduced_ChIPSeq))

# Find how many peaks are common with ChIP-Seq (peaks are reduced with 1kb extension from each side)
common_with_ChIPSeq_reduced=GRangesList(constant_peaks=GRanges(), common_38_39=GRanges(),
                                common_38_40=GRanges(), common_39_40=GRanges(), 
                                unique_38=GRanges(), unique_39=GRanges(), unique_40=GRanges())
for (experiment in c("ChIAPET", "HiChIP")){
  for (com_groups in names(common_with_ChIPSeq_reduced)){
    common_with_ChIPSeq_reduced[[com_groups]]=subsetByOverlaps(get(paste0("true_common_peaks_reduced_", experiment))[[com_groups]], 
                                                               true_common_peaks_reduced_ChIPSeq[[com_groups]])
  }
  assign(paste0("common_with_ChIPSeq_reduced___", experiment), common_with_ChIPSeq_reduced)
}
rm(common_with_ChIPSeq_reduced)


subsetByOverlaps(unlist(true_common_peaks_reduced_ChIAPET, recursive = TRUE, use.names = TRUE), unlist(true_common_peaks_reduced_ChIPSeq, recursive = TRUE, use.names = TRUE))
chiapet_not_chipseq=subsetByOverlaps(unlist(true_common_peaks_reduced_ChIAPET, recursive = TRUE, use.names = TRUE), unlist(true_common_peaks_reduced_ChIPSeq, recursive = TRUE, use.names = TRUE), invert=TRUE)
elementNROWS(common_with_ChIPSeq_reduced___ChIAPET)

subsetByOverlaps(unlist(true_common_peaks_reduced_HiChIP, recursive = TRUE, use.names = TRUE), unlist(true_common_peaks_reduced_ChIPSeq, recursive = TRUE, use.names = TRUE))
hichip_not_chipseq=subsetByOverlaps(unlist(true_common_peaks_reduced_HiChIP, recursive = TRUE, use.names = TRUE), unlist(true_common_peaks_reduced_ChIPSeq, recursive = TRUE, use.names = TRUE), invert=TRUE)
elementNROWS(common_with_ChIPSeq_reduced___HiChIP)


#Merge GRangesList
# unlist(true_common_peaks_ChIPSeq, recursive = TRUE, use.names = TRUE)

```

# Draw common peaks inside Trios as pie charts
```{r}

cell_lines<<-c("GM19238", "GM19239", "GM19240")
experiments<<-c("ChIAPET", "HiChIP", "ChIPSeq")

for (experiment in experiments){

  peaks_common_file_string=paste0("common_peaks_for_trios_", experiment)
  size_common_peaks_trios=data.frame(com12=NROW(get(peaks_common_file_string)$com12), 
                                           com23=NROW(get(peaks_common_file_string)$com23),
                                           com13=NROW(get(peaks_common_file_string)$com13),
                                           com123=NROW(get(peaks_common_file_string)$com123))
  slices_gm38=data.frame(labels=c("unique", "GM19240", "all_trios", "GM19239"), quantity=c(NROW(get(paste0("peaks_wout_sex_chr_",experiment))$GM19238)-size_common_peaks_trios$com12-size_common_peaks_trios$com13+size_common_peaks_trios$com123,
                size_common_peaks_trios$com13-size_common_peaks_trios$com123,
                size_common_peaks_trios$com123,
                size_common_peaks_trios$com12-size_common_peaks_trios$com123))
  
  slices_gm39=data.frame(labels=c("unique", "GM19238", "all_trios", "GM19240"),
                quantity=c(NROW(get(paste0("peaks_wout_sex_chr_", experiment))$GM19239)
                -size_common_peaks_trios$com12
                -size_common_peaks_trios$com23
                +size_common_peaks_trios$com123,
                size_common_peaks_trios$com12-size_common_peaks_trios$com123,
                size_common_peaks_trios$com123,
                size_common_peaks_trios$com23-size_common_peaks_trios$com123))
  
  slices_gm40=data.frame(labels=c("unique", "GM19239", "all_trios", "GM19238"),
    quantity=c(NROW(get(paste0("peaks_wout_sex_chr_", experiment))$GM19240)
                -size_common_peaks_trios$com13
                -size_common_peaks_trios$com23
                +size_common_peaks_trios$com123,
                size_common_peaks_trios$com23-size_common_peaks_trios$com123,
                size_common_peaks_trios$com123,
                size_common_peaks_trios$com13-size_common_peaks_trios$com123))

  
  # lbls <- paste0("unique", "GM19240", "all_trios", "GM19239")
  # pie(slices_gm38, labels = lbls, main="Pie Chart for GM19238")
  # 
  # lbls <- c("unique", "GM19238", "all_trios", "GM19240")
  # pie(slices_gm39, labels = lbls, main="Pie Chart for GM19239")
  # 
  # lbls <- c("unique", "GM19239", "all_trios", "GM19238")
  # pie(slices_gm40, labels = lbls, main="Pie Chart for GM19240")
  
  #     par(
  #   mfrow=c(1,3),
  #   mar=c(3,3,3,3)
  # )
  
  png(paste0('Common_peaks_inside_trios_pie_plot_', cell_lines[[1]], experiment, '.png'), 
      res = 300, width = 4200, height = 4200)
  plot.new()
  create_pie_plot_my(slices_gm38, cell_lines[[1]])
  while (!is.null(dev.list()))  dev.off()
  
  png(paste0('Common_peaks_inside_trios_pie_plot', cell_lines[[2]], experiment, '.png'),
      res = 300, width = 4200, height = 4200)
   plot.new()
  create_pie_plot_my(slices_gm39, cell_lines[[2]])
  while (!is.null(dev.list()))  dev.off()
  
  png(paste0('Common_peaks_inside_trios_pie_plot', cell_lines[[3]], experiment, '.png'),
      res = 300, width = 4200, height = 4200)
  plot.new()
  create_pie_plot_my(slices_gm40, cell_lines[[3]])
  while (!is.null(dev.list()))  dev.off()
}


```

# Add coverage to every peak

```{r}
# cell_lines=c("GM19238", "GM19239", "GM19240")

experiment="chiapet"
cell_line="GM19238"

reads_count_chiapet_GM19238=featureCounts(
  read_bam_file(experiment, cell_line), 
  annot.ext = convert_peak_to_df_featcnt(peaks_with_motif_ChIAPET[[cell_line]]), 
  isPairedEnd = T, 
  nthreads = 100)

peaks_with_motif_ChIAPET[[cell_line]]$coverage=unname(reads_count_chiapet_GM19238$counts[,1])

cell_line="GM19239"

reads_count_chiapet_GM19239=featureCounts(
  read_bam_file(experiment, cell_line), 
  annot.ext = convert_peak_to_df_featcnt(peaks_with_motif_ChIAPET[[cell_line]]), 
  isPairedEnd = T, 
  nthreads = 100)

peaks_with_motif_ChIAPET[[cell_line]]$coverage=unname(reads_count_chiapet_GM19239$counts[,1])

cell_line="GM19240"

reads_count_chiapet_GM19240=featureCounts(
  read_bam_file(experiment, cell_line), 
  annot.ext = convert_peak_to_df_featcnt(peaks_with_motif_ChIAPET[[cell_line]]), 
  isPairedEnd = T, 
  nthreads = 100)

peaks_with_motif_ChIAPET[[cell_line]]$coverage=unname(reads_count_chiapet_GM19240$counts[,1])

####### HiChIP ######
experiment="hichip"

cell_line="GM19238"
reads_count_hichip_GM19238=featureCounts(
  read_bam_file(experiment, cell_line), 
  annot.ext = convert_peak_to_df_featcnt(peaks_with_motif_HiChIP[[cell_line]]), 
  isPairedEnd = T, 
  nthreads = 32)
peaks_with_motif_HiChIP[[cell_line]]$coverage=unname(reads_count_hichip_GM19238$counts[,1])

cell_line="GM19239"
reads_count_hichip_GM19239=featureCounts(
  read_bam_file(experiment, cell_line), 
  annot.ext = convert_peak_to_df_featcnt(peaks_with_motif_HiChIP[[cell_line]]), 
  isPairedEnd = T, 
  nthreads = 32)
peaks_with_motif_HiChIP[[cell_line]]$coverage=unname(reads_count_hichip_GM19239$counts[,1])

cell_line="GM19240"
reads_count_hichip_GM19240=featureCounts(
  read_bam_file(experiment, cell_line), 
  annot.ext = convert_peak_to_df_featcnt(peaks_with_motif_HiChIP[[cell_line]]), 
  isPairedEnd = T, 
  nthreads = 32)
peaks_with_motif_HiChIP[[cell_line]]$coverage=unname(reads_count_hichip_GM19240$counts[,1])

####### ChIP-Seq ######
experiment="chipseq"

cell_line="GM19238"
reads_count_chipseq_GM19238=featureCounts(
  read_bam_file(experiment, cell_line), 
  annot.ext = convert_peak_to_df_featcnt(peaks_all_with_motif_ChIPSeq[[cell_line]]), 
  isPairedEnd = T, 
  nthreads = 32)
peaks_all_with_motif_ChIPSeq[[cell_line]]$coverage=unname(reads_count_chipseq_GM19238$counts[,1])

cell_line="GM19239"
reads_count_chipseq_GM19239=featureCounts(
  read_bam_file(experiment, cell_line), 
  annot.ext = convert_peak_to_df_featcnt(peaks_all_with_motif_ChIPSeq[[cell_line]]), 
  isPairedEnd = T, 
  nthreads = 32)
peaks_all_with_motif_ChIPSeq[[cell_line]]$coverage=unname(reads_count_chipseq_GM19239$counts[,1])

cell_line="GM19240"
reads_count_chipseq_GM19240=featureCounts(
  read_bam_file(experiment, cell_line), 
  annot.ext = convert_peak_to_df_featcnt(peaks_all_with_motif_ChIPSeq[[cell_line]]), 
  isPairedEnd = T, 
  nthreads = 32)
peaks_all_with_motif_ChIPSeq[[cell_line]]$coverage=unname(reads_count_chipseq_GM19240$counts[,1])


```
Calculate the TPM value
```{r}

```

# Generation of BED files (peaks and bins)
```{r}

cell_lines=c("GM19238", "GM19239", "GM19240")

### ChIA-PET ###
# Converting peaks.gr into peaks.bed 
for (cell_line in cell_lines){
  write.table(unname(data.frame(seqnames(peaks_with_motif_ChIAPET[[cell_line]]), 
                                start(peaks_with_motif_ChIAPET[[cell_line]]), 
                                end(peaks_with_motif_ChIAPET[[cell_line]]))),
              paste0("data/chiapet/peaks_ChIAPET_", cell_line, ".bed"),
              sep="\t",row.names=FALSE, quote = FALSE)
}

#Generation of bins file
chiapet_bins=IRanges::reduce(unlist(peaks_with_motif_ChIAPET, recursive = TRUE, use.names = TRUE))
write.table(unname(data.frame(seqnames(chiapet_bins),
                              start(chiapet_bins),
                              end(chiapet_bins))),
            paste0("data//chiapet/bins_ChIAPET.bed"),
            sep="\t",row.names=FALSE, quote = FALSE)


### HiChIP ###
cell_lines=c("GM19238", "GM19239", "GM19240")
# Converting peaks.gr into peaks.bed 
for (cell_line in cell_lines){
  write.table(unname(data.frame(seqnames(peaks_with_motif_HiChIP[[cell_line]]), 
                                start(peaks_with_motif_HiChIP[[cell_line]]), 
                                end(peaks_with_motif_HiChIP[[cell_line]]))),
              paste0("data/hichip/peaks_HiChIP_", cell_line, ".bed"),
              sep="\t",row.names=FALSE, quote = FALSE)
}

#Generation of bins file
hichip_bins=IRanges::reduce(unlist(peaks_with_motif_HiChIP, recursive = TRUE, use.names = TRUE))
write.table(unname(data.frame(seqnames(hichip_bins),
                              start(hichip_bins),
                              end(hichip_bins))),
            paste0("data/hichip/bins_HiChIP.bed"),
            sep="\t",row.names=FALSE, quote = FALSE)

### HiChIP 2 replicates ###

cell_lines=c("GM19238_rep1", "GM19238_rep2", "GM19239_rep1", "GM19239_rep2","GM19240_rep1","GM19240_rep2")

for (cell_line in cell_lines){
  write.table(unname(data.frame(seqnames(rep2_peaks_all_with_motif_HiChIP[[cell_line]]), 
                                start(rep2_peaks_all_with_motif_HiChIP[[cell_line]]), 
                                end(rep2_peaks_all_with_motif_HiChIP[[cell_line]]))),
              paste0("data/hichip/", cell_line, "/peaks_HiChIP_", cell_line, ".bed"),
              sep="\t",row.names=FALSE, quote = FALSE)
}

# #Generation of bins file
# hichip_bins_2rep=IRanges::reduce(unlist(rep2_peaks_all_with_motif_HiChIP, recursive = TRUE, use.names = TRUE))
# write.table(unname(data.frame(seqnames(hichip_bins_2rep),
#                               start(hichip_bins_2rep),
#                               end(hichip_bins_2rep))),
#             paste0(abs_path, "/hichip/bins_HiChIP_2rep.bed"),
#             sep="\t",row.names=FALSE, quote = FALSE)

#Generation of bins file
hichip_bins=IRanges::reduce(unlist(peaks_with_motif_HiChIP, recursive = TRUE, use.names = TRUE))
write.table(unname(data.frame(seqnames(hichip_bins),
                              start(hichip_bins),
                              end(hichip_bins))),
            paste0("data/hichip/bins_HiChIP.bed"),
            sep="\t",row.names=FALSE, quote = FALSE)

### ChIAPET 2 replicates ###

cell_lines=c("GM19238_rep1", "GM19238_rep2", "GM19239_rep1", "GM19239_rep2","GM19240_rep1","GM19240_rep2")

for (cell_line in cell_lines){
  write.table(unname(data.frame(seqnames(rep2_peaks_with_motif_ChIAPET[[cell_line]]), 
                                start(rep2_peaks_with_motif_ChIAPET[[cell_line]]), 
                                end(rep2_peaks_with_motif_ChIAPET[[cell_line]]))),
              paste0("data/chiapet/peaks_ChIAPET_", cell_line, ".bed"),
              sep="\t",row.names=FALSE, quote = FALSE)
}

# #Generation of bins file
# chiapet_bins_2rep=IRanges::reduce(unlist(rep2_peaks_with_motif_ChIAPET, recursive = TRUE, use.names = TRUE))
# write.table(unname(data.frame(seqnames(chiapet_bins_2rep),
#                               start(chiapet_bins_2rep),
#                               end(chiapet_bins_2rep))),
#             paste0(abs_path, "/chiapet/bins_ChIAPET_2rep.bed"),
#             sep="\t",row.names=FALSE, quote = FALSE)

#Generation of bins file
chiapet_bins=IRanges::reduce(unlist(peaks_with_motif_ChIAPET, recursive = TRUE, use.names = TRUE))
write.table(unname(data.frame(seqnames(chiapet_bins),
                              start(chiapet_bins),
                              end(chiapet_bins))),
            paste0("data/chiapet/bins_ChIAPET.bed"),
            sep="\t",row.names=FALSE, quote = FALSE)

```


# MAnorms normalization
```{r}
### ChIA-PET ###
browseVignettes("MAnorm2")
library(MAnorm2)

experiment="chiapet"
manorms_input_chiapet.df=data.frame(read.table(
  paste0("data/", experiment, "/narrow_peaks_profile_bins.xls"), header = T))
norm=normalize(manorms_input_chiapet.df, 4:6, 7:9)

manorms_input_chiapet_ref_bin=data.frame(read.table(paste0("data/", experiment, "/fixed_size_profile_bins.xls"), header = T))
manorms_input_chiapet_ref_bin.gr=GRanges(manorms_input_chiapet_ref_bin)
norm_ref_bins_chiapet=normalize(manorms_input_chiapet_ref_bin, 4:6, 7:9)

# From cluster

norm_inp_chiapet_eden_paired=data.frame(read.table(paste0("data/", experiment, "/ref_bins_paired_profile_bins.xls"), header = T))
norm_chiapet_eden_paired=MAnorm2::normalize(norm_inp_chiapet_eden_paired, 4:6, 7:9)
unique40_chiapet_paired=norm_inp_chiapet_eden_paired[which(norm_inp_chiapet_eden_paired$GM19240.occupancy==1),]
unique40_chiapet_paired[sort(unique40_chiapet_paired$GM19240.read_cnt, index.return=T)$ix,]


norm_inp_chiapet_eden_single=data.frame(read.table(paste0("data/", experiment, "/ref_bins_single_profile_bins.xls"), header = T))
norm_chiapet_eden_single=MAnorm2::normalize(norm_inp_chiapet_eden_single, 4:6, 7:9)
#sort by the lowest value of GM19238.read_cnt
norm_chiapet_eden_single[sort(norm_chiapet_eden_single$GM19238.read_cnt, index.return=T)$ix,]
# Select only true peaks for cell_line
unique40_chiapet=norm_chiapet_eden_single[which(norm_chiapet_eden_single$GM19240.occupancy==1),]
unique40_chiapet[sort(unique40_chiapet$GM19240.read_cnt, index.return=T)$ix,]

unique39_chiapet=norm_chiapet_eden_single[which(norm_chiapet_eden_single$GM19239.occupancy==1),]
unique39_chiapet[sort(unique39_chiapet$GM19239.read_cnt, index.return=T)$ix,]

unique38_chiapet=norm_chiapet_eden_single[which(norm_chiapet_eden_single$GM19238.occupancy==1),]
unique38_chiapet[sort(unique38_chiapet$GM19238.read_cnt, index.return=T)$ix,]



constant_chiapet=norm_chiapet_eden_single[ which(norm_chiapet_eden_single$GM19238.occupancy==1 & 
                                                   norm_chiapet_eden_single$GM19239.occupancy==1 & 
                                                   norm_chiapet_eden_single$GM19240.occupancy==1),]
constant_chiapet[sort(constant_chiapet$GM19238.read_cnt, index.return=T)$ix,]
constant_chiapet[sort(constant_chiapet$GM19239.read_cnt, index.return=T)$ix,]
constant_chiapet[sort(constant_chiapet$GM19240.read_cnt, index.return=T)$ix,]

### with dedup chiapet

norm_inp_chiapet_eden_single_simple=data.frame(read.table(paste0("data/", experiment, "/chiapet_single_simple_profile_bins.xls"), header = T))
norm_chiapet_eden_single_simple=MAnorm2::normalize(norm_inp_chiapet_eden_single_simple, 4:6, 7:9)
#sort by the lowest value of GM19238.read_cnt
norm_chiapet_eden_single_simple[sort(norm_chiapet_eden_single_simple$GM19238.read_cnt, index.return=T)$ix,]
# Select only true peaks for cell_line
unique38_chiapet_simple=norm_chiapet_eden_single_simple[which(norm_chiapet_eden_single_simple$GM19238.occupancy==1),]
unique38_chiapet_simple[sort(unique38_chiapet_simple$GM19238.read_cnt, index.return=T)$ix,]

unique39_chiapet_simple=norm_chiapet_eden_single_simple[which(norm_chiapet_eden_single_simple$GM19239.occupancy==1),]
unique39_chiapet_simple[sort(unique39_chiapet_simple$GM19239.read_cnt, index.return=T)$ix,]

unique40_chiapet_simple=norm_chiapet_eden_single_simple[which(norm_chiapet_eden_single_simple$GM19240.occupancy==1),]
unique40_chiapet_simple[sort(unique40_chiapet_simple$GM19240.read_cnt, index.return=T)$ix,]





constant_chiapet_simple=norm_chiapet_eden_single_simple[ which(norm_chiapet_eden_single_simple$GM19238.occupancy==1 & 
                                                   norm_chiapet_eden_single_simple$GM19239.occupancy==1 & 
                                                   norm_chiapet_eden_single_simple$GM19240.occupancy==1),]
constant_chiapet_simple[sort(constant_chiapet_simple$GM19238.read_cnt, index.return=T)$ix,]
constant_chiapet_simple[sort(constant_chiapet_simple$GM19239.read_cnt, index.return=T)$ix,]
constant_chiapet_simple[sort(constant_chiapet_simple$GM19240.read_cnt, index.return=T)$ix,]


### Workflow proposed by CRAN ###
# One-step normalization
norm=MAnorm2::normalize(norm_inp_chiapet_eden_single_simple, c(4,5,6), c(7,8,9))
raw = log(norm_inp_chiapet_eden_single_simple[4:6] + 0.5, base = 2)

# Plot correlation between the samples
plot(attr(norm, "MA.cor"), symbreaks = TRUE, margins = c(8, 8),
     cexRow = 1, cexCol = 1)

#MA plots
png(paste0('ChIAPET_MAnorm_normalization_.png'), res = 300, width = 4200, height = 4200)
# Generating new plots and data (log2)

par(mar=c(3,3,3,3))
layout(matrix(c(1,2,3,4,5,6,1,7,3,8,5,9),ncol=2),heights=c(1,3,1,3,1,3))
plot.new()
text(0.5,0.5,"GM19238 vs GM19239",cex=3,font=2)
generate_manorm_plot(trios[1:2], norm, raw)
plot.new()
text(0.5,0.5,"GM19238 vs GM19240",cex=3,font=2)
generate_manorm_plot(trios[1:3], norm, raw)
plot.new()
text(0.5,0.5,"GM19239 vs GM19240",cex=3,font=2)
generate_manorm_plot(trios[2:3], norm , raw)
#After normalization
generate_manorm_plot(trios[1:2], norm)
generate_manorm_plot(trios[1:3], norm)
generate_manorm_plot(trios[2:3], norm)
dev.off()

# Converting to bioCond
conds=list(GM19238=bioCond(norm[[4]], norm[[7]], name="GM19238"),
           GM19239=bioCond(norm[[5]], norm[[8]], name="GM19239"),
           GM19240=bioCond(norm[[6]], norm[[9]], name="GM19240"))

### Create a "blind" biocond, to compare two groups and not two samples

# Between 38 and 39
conds$blind_38_39 <- bioCond(norm[c(4, 5)], norm[c(7, 8)], occupy.num = 2,
                       name = "blind_38_39")
conds_38_39 <- fitMeanVarCurve(conds[c(1, 2, 4)], method = "parametric",
                         occupy.only = TRUE, init.coef = c(0.1, 10))
# Visualize mean-variance trend along with the fitted MVC.
plotMeanVarCurve(conds_38_39[3], subset = "occupied", ylim = c(-7, 1))

#Between 38 and 40
conds$blind_38_40 <- bioCond(norm[c(4, 6)], norm[c(7, 9)], occupy.num = 2,
                       name = "blind_38_40")
conds_38_40 <- fitMeanVarCurve(conds[c(1, 3, 5)], method = "parametric",
                         occupy.only = TRUE, init.coef = c(0.1, 10))
# Visualize mean-variance trend along with the fitted MVC.
plotMeanVarCurve(conds_38_40[3], subset = "occupied", ylim = c(-7, 1))

#Between 39 and 40
conds$blind_39_40 <- bioCond(norm[c(5, 6)], norm[c(8, 9)], occupy.num = 2,
                       name = "blind_39_40")
conds_39_40 <- fitMeanVarCurve(conds[c(2, 3, 6)], method = "parametric",
                         occupy.only = TRUE, init.coef = c(0.1, 10))
# Visualize mean-variance trend along with the fitted MVC.
plotMeanVarCurve(conds_39_40[3], subset = "occupied", ylim = c(-7, 1))

# Between all 3 cell-lines
conds$blind_common <- bioCond(norm[c(4, 5, 6)], norm[c(7, 8, 9)], occupy.num = 3,
                       name = "blind_common")
conds_common <- fitMeanVarCurve(conds[c(1, 2, 3, 7)], method = "parametric",
                         occupy.only = TRUE, init.coef = c(0.1, 10))
# Visualize mean-variance trend along with the fitted MVC.
plotMeanVarCurve(conds_common[4], subset = "occupied", ylim = c(-7, 1))



### # Perform differential tests.
res_38_39 <- diffTest(conds_38_39[[1]], conds_38_39[[2]])
res_38_40 <- diffTest(conds_38_40[[1]], conds_38_40[[2]])
res_39_40 <- diffTest(conds_39_40[[1]], conds_39_40[[2]])

MAplot(res_38_39, pval = 0.01, ylim=c(-3, 3), main="GM19238 vs GM19239")
abline(h = 0, lwd = 2, lty = 5, col = "green3")

MAplot(res_38_40, pval = 0.01)
abline(h = 0, lwd = 2, lty = 5, col = "green3")

MAplot(res_39_40, pval = 0.01)
abline(h = 0, lwd = 2, lty = 5, col = "green3")

cor(res_39_40$pval, res_39_40$pval, method = "spearman")


# 3 groups simulaniously

norm <- normalize(norm_inp_chiapet_eden_single_simple, count = 4, occupancy = 7)
norm <- normalize(norm, count = 5, occupancy = 8)
norm <- normalize(norm, count = 6, occupancy = 9)

conds <- list(GM19238 = bioCond(norm[4], norm[7], name = "GM19238"),
              GM19239 = bioCond(norm[5], norm[8], name = "GM19239"),
              GM19240 = bioCond(norm[6], norm[9], name = "GM19240"))

conds_plot <- fitMeanVarCurve(conds[c(1,2, 3,  7)], method = "parametric", occupy.only = TRUE, init.coef = c(0.1, 10))
res <- aovBioCond(conds_plot)
plot(res,  pval = 0.01)
plot(res,  padj = 1e-6, main="GM19238 vs GM19239 vs GM19240")



```

# [HiChIP 2 rep] MANorm data processing
```{r}
experiment="hichip"
norm_inp_hichip_2rep=data.frame(read.table(paste0("data/", experiment, "/hichip_2rep_mrg_bins_profile_bins.xls"), header = T))
cell_lines=c("GM19238_rep1", "GM19238_rep2", "GM19239_rep1", "GM19239_rep2","GM19240_rep1","GM19240_rep2")
trios=c("GM19238", "GM19239", "GM19240")

### Normalize between groups
norm_hichip_2rep <- normalize(norm_inp_hichip_2rep, count = 4:5, occupancy = 10:11)
norm_hichip_2rep <- normalize(norm_hichip_2rep, count = 6:7, occupancy = 12:13)
norm_hichip_2rep <- normalize(norm_hichip_2rep, count = 8:9, occupancy = 14:15)

### Visualize the plots before/after normalization (Generating new plots and data (log2))
raw_hichip_2rep = log(norm_inp_hichip_2rep[4:9] + 0.5, base = 2)

png(paste0('HiChIP_MAnorm_2rep_normalization_mrgBins.png'), res = 300, width = 4200, height = 4200)

# Generating new plots and data (log2)
set_ylim<<-c(-2,2)
par(mar=c(3,3,3,3))
layout(matrix(c(1,2,3,4,5,6,1,7,3,8,5,9),ncol=2),heights=c(1,3,1,3,1,3))
plot.new()
text(0.5,0.5,trios[[1]],cex=3,font=2)
generate_manorm_plot(cell_lines[1:2], norm_hichip_2rep, raw_hichip_2rep)
plot.new()
text(0.5,0.5,trios[[2]],cex=3,font=2)
generate_manorm_plot(cell_lines[3:4], norm_hichip_2rep, raw_hichip_2rep)
plot.new()
text(0.5,0.5,trios[[3]],cex=3,font=2)
generate_manorm_plot(cell_lines[5:6], norm_hichip_2rep , raw_hichip_2rep)
#After normalization
generate_manorm_plot(cell_lines[1:2], norm_hichip_2rep)
generate_manorm_plot(cell_lines[3:4], norm_hichip_2rep)
generate_manorm_plot(cell_lines[5:6], norm_hichip_2rep)
dev.off()

### Construct a bioCond for each group of samples.
conds_hichip_2rep_raw <- list(
  bioCond(norm_hichip_2rep[4:5], norm_hichip_2rep[10:11], name = trios[[1]]),
  bioCond(norm_hichip_2rep[6:7], norm_hichip_2rep[12:13], name = trios[[2]]),
  bioCond(norm_hichip_2rep[8:9], norm_hichip_2rep[14:15], name = trios[[3]]))
names(conds_hichip_2rep_raw)=trios

### Perform between-group normalization.
autosome <- !(norm_inp_hichip_2rep$chrom %in% c("chrX", "chrY"))
conds_hichip_2rep <- normBioCond(conds_hichip_2rep_raw, common.peak.regions = autosome)

# Drawing MA plots on bioCond objects to visualize the normalization results 

png(paste0('HiChIP_MAnorm_2rep_trios_normalization_mrgBins.png'), res = 300, width = 4200, height = 4200)
set_ylim<<-c(-2,2)

# Generating new plots and data (log2)
par(mar=c(3,3,3,3))
layout(matrix(c(1,2,3,4,5,6,1,7,3,8,5,9),ncol=2),heights=c(1,3,1,3,1,3))
plot.new()
text(0.5,0.5,paste0(trios[1]," vs. ", trios[2]),cex=3,font=2)
generate_manorm_plot_trios(trios[1:2], conds_hichip_2rep_raw, "before")
plot.new()
text(0.5,0.5,paste0(trios[1]," vs. ", trios[3]),cex=3,font=2)
generate_manorm_plot_trios(trios[1:3], conds_hichip_2rep_raw, "before")
plot.new()
text(0.5,0.5,paste0(trios[2]," vs. ", trios[3]),cex=3,font=2)
generate_manorm_plot_trios(trios[2:3], conds_hichip_2rep_raw, "before")
#After normalization
generate_manorm_plot_trios(trios[1:2], conds_hichip_2rep, "after")
generate_manorm_plot_trios(trios[1:3], conds_hichip_2rep, "after")
generate_manorm_plot_trios(trios[2:3], conds_hichip_2rep, "after")
dev.off()

### Fit an MVC.
conds_hichip_2rep <- fitMeanVarCurve(conds_hichip_2rep, 
                                     method = "parametric", 
                                     occupy.only = TRUE,
                                     init.coef = c(0.1, 10))
### Plot only occupied genomic intervals,
# as only these intervals have been used to fit the MVC.
plotMeanVarCurve(conds_hichip_2rep, subset = "occupied", ylim = c(-7, 0.5))

### Perform differential tests.
res_hichip_rep2=list(aovBioCond(conds_hichip_2rep),
                     diffTest(conds_hichip_2rep[[1]], conds_hichip_2rep[[2]]),
                     diffTest(conds_hichip_2rep[[1]], conds_hichip_2rep[[3]]),
                     diffTest(conds_hichip_2rep[[2]], conds_hichip_2rep[[3]]))
names(res_hichip_rep2)=c("all_trios", 
                         paste0(trios[1],"_",trios[2]),
                         paste0(trios[1],"_",trios[3]), 
                         paste0(trios[2],"_",trios[3]))

# Visualize the results

png(paste0('HiChIP_MAnorm_2rep_trios_diff_test_mrgBins.png'), res = 300, width = 2200, height = 2200)
par(mar=c(2.3,2.3,2.3,2.3))
layout(matrix(c(1,2,3,4,1,5,3,4,1,6,3,4),ncol=3),heights=c(1,3,1,3,1,3))

plot.new()
text(0.5,0.5,"Within paris of trios ",cex=3,font=2)
MAplot(res_hichip_rep2$GM19238_GM19239, padj = 0.001, ylim = c(-2, 2), main=paste0(trios[1]," vs. ", trios[2]), line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
plot.new()
text(0.5,0.5,"Within all trios ",cex=3,font=2)
plot(res_hichip_rep2$all_trios, padj = 1e-6,line=0.2)
MAplot(res_hichip_rep2$GM19238_GM19240, padj = 0.001,ylim = c(-2, 2), main=paste0(trios[1]," vs. ", trios[3]), line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
MAplot(res_hichip_rep2$GM19239_GM19240, padj = 0.001,ylim = c(-2, 2), main=paste0(trios[2]," vs. ", trios[3]),line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
dev.off()

```

# [HiChIP 2 rep] Analysis of the results 
```{r}
experiment="HiChIP"

# Create tables that will include all important information for the analysis
common_hichip_manorm_2rep=list(
  create_table_common_peaks_with_info(norm_hichip_2rep, res_hichip_rep2, conds_hichip_2rep, trios[1:2]),              
  create_table_common_peaks_with_info(norm_hichip_2rep, res_hichip_rep2, conds_hichip_2rep, trios[c(1,3)]),               
  create_table_common_peaks_with_info(norm_hichip_2rep, res_hichip_rep2, conds_hichip_2rep, trios[2:3]))

names(common_hichip_manorm_2rep)=c(
  paste0(paste0(str_sub(trios[1],1,2),str_sub(trios[1],start=6)),"_",paste0(str_sub(trios[2],1,2),str_sub(trios[2],start=6))),
  paste0(paste0(str_sub(trios[1],1,2),str_sub(trios[1],start=6)),"_",paste0(str_sub(trios[3],1,2),str_sub(trios[3],start=6))),
  paste0(paste0(str_sub(trios[2],1,2),str_sub(trios[2],start=6)),"_",paste0(str_sub(trios[3],1,2),str_sub(trios[3],start=6))))

# Create additional tables with lower and higher values of mean values (select the squares)
mean_range=c(10,10)
common_hichip_manorm_2rep=add_greater_and_lower_mean_ranges_tables(common_hichip_manorm_2rep, mean_range, trios[1:2])
common_hichip_manorm_2rep=add_greater_and_lower_mean_ranges_tables(common_hichip_manorm_2rep, mean_range, trios[c(1,3)])
common_hichip_manorm_2rep=add_greater_and_lower_mean_ranges_tables(common_hichip_manorm_2rep, mean_range, trios[2:3])

# Create false pos tables
par="isPadj"

pos_false_tables_hichip_2rep=list(
  create_fp_tables_and_save_graphs(common_hichip_manorm_2rep[[1]],trios[1:2], experiment, "all_mrgBins", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm_2rep[[4]],trios[1:2], experiment, "mean>=10_mrgBins", par),      
  create_fp_tables_and_save_graphs(common_hichip_manorm_2rep[[5]],trios[1:2], experiment, "mean<10_mrgBins", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm_2rep[[2]],trios[c(1,3)], experiment, "all_mrgBins", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm_2rep[[6]],trios[c(1,3)], experiment, "mean>=10_mrgBins", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm_2rep[[7]],trios[c(1,3)], experiment, "mean<10_mrgBins", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm_2rep[[3]],trios[2:3], experiment, "all_mrgBins", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm_2rep[[8]],trios[2:3], experiment, "mean>=10_mrgBins", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm_2rep[[9]],trios[2:3], experiment, "mean<10_mrgBins", par))

names(pos_false_tables_hichip_2rep)=names(common_hichip_manorm_2rep)[c(1,4,5,2,6,7,3,8,9)]

# Create confusion tables for every pairs of replicates and freater and lower ranges               
               
confusion_tables_hichip_2rep=vector(mode="list", length=NROW(pos_false_tables_hichip_2rep))
names(confusion_tables_hichip_2rep)=names(pos_false_tables_hichip_2rep)
for (i in 1:NROW(confusion_tables_hichip_2rep)){
  confusion_tables_hichip_2rep[i]=list(caret::confusionMatrix(factor(common_hichip_manorm_2rep[[names(confusion_tables_hichip_2rep)[i]]]$common_padj, levels=c(TRUE, FALSE)), 
                       factor(common_hichip_manorm[[names(confusion_tables_hichip_2rep)[i]]]$predicted_rev, levels=c(TRUE, FALSE)),
                       dnn=c("padj>0.001", "SPP_detected")))
}


# pos_false_tables_hichip$GM38_GM39_mean_gr10$GM38T_GM38F[pos_false_tables_hichip$GM38_GM39_mean_gr10$GM38T_GM38F$end-pos_false_tables_hichip$GM38_GM39_mean_gr10$GM38T_GM38F$start<=5000,]

# 4 CASES
confusion_data_hichip_2rep=list(
       # Both show common (TP)
  list(TP=pos_false_tables_hichip_2rep[[1]][[1]][pos_false_tables_hichip_2rep[[1]][[1]]$common_pval==TRUE,],
       # Spp pokazuje tak, a padj pokazuje róźną siłę (FP)
       FP=pos_false_tables_hichip_2rep[[1]][[1]][pos_false_tables_hichip_2rep[[1]][[1]]$common_pval==FALSE,], 
       # SPP pokazuje nie, a padj pokazuje, że siła jest taka sama (FN)
       FN=pos_false_tables_hichip_2rep[[1]][["false_peaks"]][pos_false_tables_hichip_2rep[[1]][["false_peaks"]]$common_pval==TRUE,],
       # SPP pokazuje nie i padj się zgadza  (TN)
       TN=pos_false_tables_hichip_2rep[[1]][["false_peaks"]][pos_false_tables_hichip_2rep[[1]][["false_peaks"]]$common_pval==FALSE,]),
  list(TP=pos_false_tables_hichip_2rep[[4]][[1]][pos_false_tables_hichip_2rep[[4]][[1]]$common_pval==TRUE,],
       
       # Spp pokazuje tak, a padj pokazuje róźną siłę (FP)
       FP=pos_false_tables_hichip_2rep[[4]][[1]][pos_false_tables_hichip_2rep[[4]][[1]]$common_pval==FALSE,],
       # SPP pokazuje nie, a padj pokazuje, że siła jest taka sama (FN)
       FN=pos_false_tables_hichip_2rep[[4]][["false_peaks"]][pos_false_tables_hichip_2rep[[4]][["false_peaks"]]$common_pval==TRUE,],
       # SPP pokazuje nie i padj się zgadza  (TN)
       TN=pos_false_tables_hichip_2rep[[4]][["false_peaks"]][pos_false_tables_hichip_2rep[[4]][["false_peaks"]]$common_pval==FALSE,]),
  
  list(TP=pos_false_tables_hichip_2rep[[7]][[1]][pos_false_tables_hichip_2rep[[7]][[1]]$common_pval==TRUE,],
       # Spp pokazuje tak, a padj pokazuje róźną siłę (FP)
       FP=pos_false_tables_hichip_2rep[[7]][[1]][pos_false_tables_hichip_2rep[[7]][[1]]$common_pval==FALSE,],
       # SPP pokazuje nie, a padj pokazuje, że siła jest taka sama (FN)
       FN=pos_false_tables_hichip_2rep[[7]][["false_peaks"]][pos_false_tables_hichip_2rep[[7]][["false_peaks"]]$common_pval==TRUE,],
       # SPP pokazuje nie i padj się zgadza  (TN)
       TN=pos_false_tables_hichip_2rep[[7]][["false_peaks"]][pos_false_tables_hichip_2rep[[7]][["false_peaks"]]$common_pval==FALSE,]))

names(confusion_data_hichip_2rep)=names(common_hichip_manorm_2rep)[1:3]

```

# [HiChIP 2 rep < 5kb] Select only peaks that are less than 5000 kb
```{r}

common_hichip_manorm$GM38_GM39_mean_gr10[common_hichip_manorm$GM38_GM39_mean_gr10$end-common_hichip_manorm$GM38_GM39_mean_gr10$start>5000 & common_hichip_manorm$GM38_GM39_mean_gr10$padj>0.001 ,]


experiment="HiChIP"
n=5000
# Create tables that will include all important information for the analysis
common_hichip_manorm_5kb=common_hichip_manorm
common_hichip_manorm_5kb=list(GM38_GM39=common_hichip_manorm_5kb$GM38_GM39[common_hichip_manorm_5kb$GM38_GM39$end-common_hichip_manorm_5kb$GM38_GM39$start<=n,],
                              GM38_GM40=common_hichip_manorm_5kb$GM38_GM40[common_hichip_manorm_5kb$GM38_GM40$end-common_hichip_manorm_5kb$GM38_GM40$start<=n,],
                              GM39_GM40=common_hichip_manorm_5kb$GM39_GM40[common_hichip_manorm_5kb$GM39_GM40$end-common_hichip_manorm_5kb$GM39_GM40$start<=n,])

# Create additional tables with lower and higher values of mean values (select the squares)
mean_range=c(10,10)
common_hichip_manorm_5kb$GM38_GM39_mean_gr10=common_hichip_manorm_5kb$GM38_GM39[common_hichip_manorm_5kb$GM38_GM39$GM19238.mean>=mean_range[1]&
                                                                        common_hichip_manorm_5kb$GM38_GM39$GM19239.mean>=mean_range[2],]
common_hichip_manorm_5kb$GM38_GM39_mean_lw10=common_hichip_manorm_5kb$GM38_GM39[common_hichip_manorm_5kb$GM38_GM39$GM19238.mean<mean_range[1]&
                                                                        common_hichip_manorm_5kb$GM38_GM39$GM19239.mean<mean_range[2],]
common_hichip_manorm_5kb$GM38_GM40_mean_gr10=common_hichip_manorm_5kb$GM38_GM40[common_hichip_manorm_5kb$GM38_GM40$GM19238.mean>=mean_range[1]&
                                                                        common_hichip_manorm_5kb$GM38_GM40$GM19240.mean>=mean_range[2],]
common_hichip_manorm_5kb$GM38_GM40_mean_lw10=common_hichip_manorm_5kb$GM38_GM40[common_hichip_manorm_5kb$GM38_GM40$GM19238.mean<mean_range[1]&
                                                                        common_hichip_manorm_5kb$GM38_GM40$GM19240.mean<mean_range[2],]
common_hichip_manorm_5kb$GM39_GM40_mean_gr10=common_hichip_manorm_5kb$GM39_GM40[common_hichip_manorm_5kb$GM39_GM40$GM19239.mean>=mean_range[1]&
                                                                        common_hichip_manorm_5kb$GM39_GM40$GM19240.mean>=mean_range[2],]
common_hichip_manorm_5kb$GM39_GM40_mean_lw10=common_hichip_manorm_5kb$GM39_GM40[common_hichip_manorm_5kb$GM39_GM40$GM19239.mean<mean_range[1]&
                                                                        common_hichip_manorm_5kb$GM39_GM40$GM19240.mean<mean_range[2],]

pos_false_tables_hichip_5kb=list(GM38_GM39=create_fp_tables_and_save_graphs(common_hichip_manorm_5kb$GM38_GM39,trios[1:2], experiment, "all_5kb"),
                                 GM38_GM39_mean_gr10=create_fp_tables_and_save_graphs(common_hichip_manorm_5kb$GM38_GM39_mean_gr10,trios[1:2], experiment, "mean>=10_5kb"),
                                 GM38_GM39_mean_lw10=create_fp_tables_and_save_graphs(common_hichip_manorm_5kb$GM38_GM39_mean_lw10,trios[1:2], experiment, "mean<10_5kb"),
                                 GM38_GM40=create_fp_tables_and_save_graphs(common_hichip_manorm_5kb$GM38_GM40,trios[1:3], experiment, "all_5kb"),
                                 GM38_GM40_mean_gr10=create_fp_tables_and_save_graphs(common_hichip_manorm_5kb$GM38_GM40_mean_gr10,trios[1:3], experiment, "mean>=10_5kb"),
                                 GM38_GM40_mean_lw10=create_fp_tables_and_save_graphs(common_hichip_manorm_5kb$GM38_GM40_mean_lw10,trios[1:3], experiment, "mean<10_5kb"),
                                 GM39_GM40=create_fp_tables_and_save_graphs(common_hichip_manorm_5kb$GM39_GM40,trios[2:3], experiment, "all_5kb"),
                                 GM39_GM40_mean_gr10=create_fp_tables_and_save_graphs(common_hichip_manorm_5kb$GM39_GM40_mean_gr10,trios[2:3], experiment, "mean>=10_5kb"),
                                 GM39_GM40_mean_lw10=create_fp_tables_and_save_graphs(common_hichip_manorm_5kb$GM39_GM40_mean_lw10,trios[2:3], experiment, "mean<10_5kb"))


confusion_tables_hichip_5kb=vector(mode="list", length=NROW(pos_false_tables_hichip_5kb))
names(confusion_tables_hichip_5kb)=names(pos_false_tables_hichip_5kb)
for (i in 1:NROW(confusion_tables_hichip_5kb)){
  confusion_tables_hichip_5kb[i]=list(caret::confusionMatrix(factor(common_hichip_manorm_5kb[[names(confusion_tables_hichip_5kb)[i]]]$common_padj, levels=c(TRUE, FALSE)), 
                       factor(common_hichip_manorm_5kb[[names(confusion_tables_hichip_5kb)[i]]]$predicted_rev, levels=c(TRUE, FALSE)),
                       dnn=c("padj>0.001", "SPP_detected")))
}

pos_false_tables_hichip_5kb$GM38_GM39_mean_gr10$GM38T_GM38T[pos_false_tables_hichip_5kb$GM38_GM39_mean_gr10$GM38T_GM38T$padj<0.001,]
pos_false_tables_hichip_5kb$GM38_GM39_mean_lw10$GM38T_GM38T[pos_false_tables_hichip_5kb$GM38_GM39_mean_lw10$GM38T_GM38T$padj>0.001,]

```

# [HiChIP merged] MANorm data processing
```{r}
experiment="hichip"
trios=c("GM19238", "GM19239", "GM19240")
norm_inp_hichip=data.frame(read.table(paste0("data/", experiment, "/hichip_merged_profile_bins.xls"), header = T))

### Visualize the plots before/after normalization (Generating new plots and data (log2))
raw_hichip = log(norm_inp_hichip[4:6] + 0.5, base = 2)

### Normalize between cell lines
autosome <- !(norm_inp_hichip$chrom %in% c("chrX", "chrY"))
norm_hichip <- normalize(norm_inp_hichip, c(4:6), c(7:9), common.peak.regions = autosome)

png(paste0('plots/HiChIP_MAnorm_merRep_normalization.png'), res = 300, width = 4200, height = 4200)

# Generating new plots and data (log2)
set_ylim<<-c(-2,2)
par(mar=c(3,3,3,3))
layout(matrix(c(1,2,3,4,5,6,1,7,3,8,5,9),ncol=2),heights=c(1,3,1,3,1,3))
plot.new()
text(0.5,0.5,paste0(trios[1],' vs. ', trios[2]),cex=3,font=2)
generate_manorm_plot(trios[1:2], norm_hichip, raw_hichip)
plot.new()
text(0.5,0.5,paste0(trios[1],' vs. ', trios[3]),cex=3,font=2)
generate_manorm_plot(trios[1:3], norm_hichip, raw_hichip)
plot.new()
text(0.5,0.5,paste0(trios[2],' vs. ', trios[3]),cex=3,font=2)
generate_manorm_plot(trios[2:3], norm_hichip , raw_hichip)
#After normalization
generate_manorm_plot(trios[1:2], norm_hichip)
generate_manorm_plot(trios[1:3], norm_hichip)
generate_manorm_plot(trios[2:3], norm_hichip)
dev.off()

### Construct a bioCond for each group of samples.
conds_hichip <- list(
  bioCond(norm_hichip[4], norm_hichip[7], name = trios[1]),
  bioCond(norm_hichip[5], norm_hichip[8], name = trios[2]),
  bioCond(norm_hichip[6], norm_hichip[9], name = trios[3]))
names(conds_hichip)=trios

### Perform between-group normalization.
# autosome <- !(norm_inp_hichip$chrom %in% c("chrX", "chrY"))
# conds_hichip$blind=bioCond()
# conds_hichip <- normBioCond(conds_hichip_2rep_raw, common.peak.regions = autosome)

### Create a "blind" biocond, to compare two groups and not two samples

conds_hichip$blind_1 <- bioCond(norm_hichip[c(4, 5)], norm_hichip[c(7, 8)], occupy.num = 2)
conds_hichip$blind_2 <- bioCond(norm_hichip[c(4, 6)], norm_hichip[c(7, 9)], occupy.num = 2)
conds_hichip$blind_3 <- bioCond(norm_hichip[c(5, 6)], norm_hichip[c(8, 9)], occupy.num = 2)
conds_hichip$blind_common <- bioCond(norm_hichip[c(4, 5, 6)], norm_hichip[c(7, 8, 9)], occupy.num = 3)

names(conds_hichip)[4:7]=c(paste0("blind_", trios[1],"_",trios[2]), 
                           paste0("blind_", trios[1],"_",trios[3]),
                           paste0("blind_", trios[2],"_",trios[3]),
                           "blind_common")

conds_hichip_meanCurve=list(fitMeanVarCurve(conds_hichip[c(1, 2, 3, 7)], method = "parametric",
                         occupy.only = TRUE, init.coef = c(0.1, 10)),
                            fitMeanVarCurve(conds_hichip[c(1, 2, 4)], method = "parametric",
                         occupy.only = TRUE, init.coef = c(0.1, 10)),
                            fitMeanVarCurve(conds_hichip[c(1, 3, 5)], method = "parametric",
                         occupy.only = TRUE, init.coef = c(0.1, 10)),
                            fitMeanVarCurve(conds_hichip[c(2, 3, 6)], method = "parametric",
                         occupy.only = TRUE, init.coef = c(0.1, 10)))
names(conds_hichip_meanCurve)=c("all_trios", 
                                     paste0(trios[1],"_",trios[2]),
                                     paste0(trios[1],"_",trios[3]),
                                     paste0(trios[2],"_",trios[3]))

# Visualize mean-variance trend along with the fitted MVC.Plots are not being saved
plotMeanVarCurve(conds_hichip_meanCurve[[2]][3], subset = "occupied", ylim = c(-7, 1))
plotMeanVarCurve(conds_hichip_meanCurve[[3]][3], subset = "occupied", ylim = c(-7, 1))
plotMeanVarCurve(conds_hichip_meanCurve[[4]][3], subset = "occupied", ylim = c(-7, 1))
plotMeanVarCurve(conds_hichip_meanCurve$all_trios[4], subset = "occupied", ylim = c(-7, 1))

### # Perform differential tests
res_hichip=list(
  aovBioCond(conds_hichip_meanCurve$all_trios),
  diffTest(conds_hichip_meanCurve[[2]][[1]], conds_hichip_meanCurve[[2]][[2]]),
  diffTest(conds_hichip_meanCurve[[3]][[1]], conds_hichip_meanCurve[[3]][[2]]),
  diffTest(conds_hichip_meanCurve[[4]][[1]], conds_hichip_meanCurve[[4]][[2]]))
names(res_hichip)=names(conds_hichip_meanCurve)

# Visualize the results

png(paste0('plots/',prop_name(experiment),'_MAnorm_merRep_trios_diff_test.png'), res = 300, width = 2200, height = 2200)
par(mar=c(2.3,2.3,2.3,2.3))
layout(matrix(c(1,2,3,4,1,5,3,4,1,6,3,4),ncol=3),heights=c(1,3,1,3,1,3))

plot.new()
text(0.5,0.5,"Within paris of trios ",cex=3,font=2)
MAplot(res_hichip$GM19238_GM19239, pval = 0.05, ylim = c(-2, 2), main=paste0(trios[1]," vs. ", trios[2]), line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
plot.new()
text(0.5,0.5,"Within all trios ",cex=3,font=2)
plot(res_hichip$all_trios, pval = 0.05,line=0.2)
MAplot(res_hichip$GM19238_GM19240, pval = 0.05,ylim = c(-2, 2), main=paste0(trios[1]," vs. ", trios[3]), line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
MAplot(res_hichip$GM19239_GM19240, pval = 0.05,ylim = c(-2, 2), main=paste0(trios[2]," vs. ", trios[3]),line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
dev.off()

#Define the correlation between single and merged replicates
correaltion_hichip_mer_vs_2rep=c()
for (name in names(res_hichip)){
  correaltion_hichip_mer_vs_2rep[[name]]=cor(res_hichip_rep2[[name]]$pval, res_hichip[[name]]$pval, method = "spearman")
}

png(paste0('plots/',prop_name(experiment),'_correlation_pval_single_merged.png'), res = 300, width = 2200, height = 1100)
layout(matrix(c(1,3,7,2,4,8,2,5,9,2,6,10),ncol=4),heights=c(1,3,0.5,1,3,0.5,1,3,0.5,1,3,0.5), widths=c(2, 1.5, 1.5, 1.5))

par(mar=c(0,0,0,0))
plot.new()
text(0.5,0.5,"All trios",cex=1.5,font=2)
plot.new()
text(0.5,0.5,"Within pairs of trios",cex=1.5,font=2)

par(mar=c(4,4,1,0.5))
plot(-log10(res_hichip_rep2[[1]]$pval), -log10(res_hichip[[1]]$pval), col = "#0000FF14", pch = 20, xlab = "With Reps", ylab = "Without Reps")
plot(-log10(res_hichip_rep2[[2]]$pval), -log10(res_hichip[[2]]$pval), col = "#0000FF14", pch = 20, xlab = "With Reps", ylab = 'Without Reps', main=names(res_hichip_rep2)[[2]])
plot(-log10(res_hichip_rep2[[3]]$pval), -log10(res_hichip[[3]]$pval), col = "#0000FF14", pch = 20, xlab = "With Reps", ylab = "Without Reps", main=names(res_hichip_rep2)[[3]])
plot(-log10(res_hichip_rep2[[4]]$pval), -log10(res_hichip[[4]]$pval), col = "#0000FF14", pch = 20, xlab = "With Reps", ylab = "Without Reps", main=names(res_hichip_rep2)[[4]])

par(mar=c(0,0,0,0))
plot.new()
text(0.66, 0.66,paste0("cor = ",round(correaltion_hichip_mer_vs_2rep[[1]],2)),cex=1,font=2)
plot.new()
text(0.66, 0.66,paste0("cor = ",round(correaltion_hichip_mer_vs_2rep[[2]],2)),cex=1,font=2)
plot.new()
text(0.66, 0.66,paste0("cor = ",round(correaltion_hichip_mer_vs_2rep[[3]],2)),cex=1,font=2)
plot.new()
text(0.66, 0.66,paste0("cor = ",round(correaltion_hichip_mer_vs_2rep[[4]],2)),cex=1,font=2)

#[-log10(pval)]

```

# [HiChIP merged] Analysis of the results
```{r}
experiment="HiChIP"
trios=c("GM19238", "GM19239", "GM19240")

# Create tables that will include all important information for the analysis
common_hichip_manorm=list(
  create_table_common_peaks_with_info(norm_hichip, res_hichip, conds_hichip, trios[1:2]),
  create_table_common_peaks_with_info(norm_hichip, res_hichip, conds_hichip, trios[c(1,3)]),
  create_table_common_peaks_with_info(norm_hichip, res_hichip, conds_hichip, trios[2:3]))

names(common_hichip_manorm)=create_short_name_for_col(trios)

# Create additional tables with lower and higher values of mean values (select the squares)
mean_range=c(10,10)

common_hichip_manorm=add_greater_and_lower_mean_ranges_tables(common_hichip_manorm, mean_range, trios[1:2])
common_hichip_manorm=add_greater_and_lower_mean_ranges_tables(common_hichip_manorm, mean_range, trios[c(1,3)])
common_hichip_manorm=add_greater_and_lower_mean_ranges_tables(common_hichip_manorm, mean_range, trios[2:3])

# Create false pos tables
par="isPval"

pos_false_tables_hichip=list(
  create_fp_tables_and_save_graphs(common_hichip_manorm[[1]],trios[1:2], experiment, "all_mrgRep", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm[[4]],trios[1:2], experiment, "mean>=10_mrgRep", par),      
  create_fp_tables_and_save_graphs(common_hichip_manorm[[5]],trios[1:2], experiment, "mean<10_mrgRep", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm[[2]],trios[c(1,3)], experiment, "all_mrgBins", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm[[6]],trios[c(1,3)], experiment, "mean>=10_mrgRep", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm[[7]],trios[c(1,3)], experiment, "mean<10_mrgRep", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm[[3]],trios[2:3], experiment, "all_mrgRep", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm[[8]],trios[2:3], experiment, "mean>=10_mrgRep", par),
  create_fp_tables_and_save_graphs(common_hichip_manorm[[9]],trios[2:3], experiment, "mean<10_mrgRep", par))

names(pos_false_tables_hichip)=names(common_hichip_manorm)[c(1,4,5,2,6,7,3,8,9)]

# Create confusion tables for every pairs of replicates and freater and lower ranges              
confusion_tables_hichip=vector(mode="list", length=NROW(pos_false_tables_hichip))
names(confusion_tables_hichip)=names(pos_false_tables_hichip)
for (i in 1:NROW(confusion_tables_hichip)){
  confusion_tables_hichip[i]=list(caret::confusionMatrix(factor(common_hichip_manorm[[names(confusion_tables_hichip)[i]]]$common_pval, levels=c(TRUE, FALSE)), 
                       factor(common_hichip_manorm[[names(confusion_tables_hichip)[i]]]$predicted_rev, levels=c(TRUE, FALSE)),
                       dnn=c("pval>0.05", "SPP_detected")))
}

# 4 CASES

confusion_data_hichip=list(
       # Both show common (TP)
  list(TP=pos_false_tables_hichip[[1]][[1]][pos_false_tables_hichip[[1]][[1]]$common_pval==TRUE,],
       # Spp pokazuje tak, a padj pokazuje róźną siłę (FP)
       FP=pos_false_tables_hichip[[1]][[1]][pos_false_tables_hichip[[1]][[1]]$common_pval==FALSE,], 
       # SPP pokazuje nie, a padj pokazuje, że siła jest taka sama (FN)
       FN=pos_false_tables_hichip[[1]][["false_peaks"]][pos_false_tables_hichip[[1]][["false_peaks"]]$common_pval==TRUE,],
       # SPP pokazuje nie i padj się zgadza  (TN)
       TN=pos_false_tables_hichip[[1]][["false_peaks"]][pos_false_tables_hichip[[1]][["false_peaks"]]$common_pval==FALSE,]),
  list(TP=pos_false_tables_hichip[[4]][[1]][pos_false_tables_hichip[[4]][[1]]$common_pval==TRUE,],
       
       # Spp pokazuje tak, a padj pokazuje róźną siłę (FP)
       FP=pos_false_tables_hichip[[4]][[1]][pos_false_tables_hichip[[4]][[1]]$common_pval==FALSE,],
       # SPP pokazuje nie, a padj pokazuje, że siła jest taka sama (FN)
       FN=pos_false_tables_hichip[[4]][["false_peaks"]][pos_false_tables_hichip[[4]][["false_peaks"]]$common_pval==TRUE,],
       # SPP pokazuje nie i padj się zgadza  (TN)
       TN=pos_false_tables_hichip[[4]][["false_peaks"]][pos_false_tables_hichip[[4]][["false_peaks"]]$common_pval==FALSE,]),
  
  list(TP=pos_false_tables_hichip[[7]][[1]][pos_false_tables_hichip[[7]][[1]]$common_pval==TRUE,],
       # Spp pokazuje tak, a padj pokazuje róźną siłę (FP)
       FP=pos_false_tables_hichip[[7]][[1]][pos_false_tables_hichip[[7]][[1]]$common_pval==FALSE,],
       # SPP pokazuje nie, a padj pokazuje, że siła jest taka sama (FN)
       FN=pos_false_tables_hichip[[7]][["false_peaks"]][pos_false_tables_hichip[[7]][["false_peaks"]]$common_pval==TRUE,],
       # SPP pokazuje nie i padj się zgadza  (TN)
       TN=pos_false_tables_hichip[[7]][["false_peaks"]][pos_false_tables_hichip[[7]][["false_peaks"]]$common_pval==FALSE,]))

names(confusion_data_hichip)=names(common_hichip_manorm)[1:3]

```
# [HiChIP merged] Select possible constant peaks
```{r}

pos_false_table=pos_false_tables_hichip

### Were unique for pairs of cell lines
# Between 38_39 and 40 --> + 1017
# Between 38_40 and 39 --> + 2377
# Between 39_40 and 38 --> + 722

hichip_fn_ids=list(
  fn_38_39=intersect(
  row.names(pos_false_table[[1]][[1]]),
  unique(row.names(pos_false_table[[4]][[4]][pos_false_table[[4]][[4]]$common_pval==TRUE,]),
              row.names(pos_false_table[[7]][[4]][pos_false_table[[7]][[4]]$common_pval==TRUE,]))),
  fn_38_40=intersect(
  row.names(pos_false_table[[4]][[1]]),
  unique(row.names(pos_false_table[[1]][[4]][pos_false_table[[1]][[4]]$common_pval==TRUE,]),
              row.names(pos_false_table[[7]][[5]][pos_false_table[[7]][[5]]$common_pval==TRUE,]))),
  
  fn_39_40=intersect(
  row.names(pos_false_table[[7]][[1]]),
  unique(row.names(pos_false_table[[1]][[5]][pos_false_table[[1]][[5]]$common_pval==TRUE,]),
              row.names(pos_false_table[[4]][[5]][pos_false_table[[4]][[5]]$common_pval==TRUE,]))),
  
### Were unique for each cell_line
# Between 38 and other cell_lines --> 4266 vs 2911 >> 1729 common
# Between 39 and other cell_lines --> 1136 vs 1450 >> 375 common
# Between 40 and other cell_lines --> 4041 vs 5912 >> 3253 common
  
  fn_38=intersect(
    row.names(pos_false_table[[1]]$false_peaks[pos_false_table[[1]]$false_peaks$common_pval==TRUE &                                           
                                               pos_false_table[[1]]$false_peaks[[paste0(trios[[1]],".occupancy")]]==TRUE & 
                                               pos_false_table[[1]]$false_peaks[[paste0(trios[[2]],".occupancy")]]==FALSE ,]),
    row.names(pos_false_table[[4]]$false_peaks[pos_false_table[[4]]$false_peaks$common_pval==TRUE &                                               
                                               pos_false_table[[4]]$false_peaks[[paste0(trios[[1]],".occupancy")]]==TRUE &
                                               pos_false_table[[4]]$false_peaks[[paste0(trios[[3]],".occupancy")]]==FALSE,])),
  fn_39=intersect(
    row.names(pos_false_table[[1]]$false_peaks[pos_false_table[[1]]$false_peaks$common_pval==TRUE &                                             
                                               pos_false_table[[1]]$false_peaks[[paste0(trios[[1]],".occupancy")]]==FALSE &
                                               pos_false_table[[1]]$false_peaks[[paste0(trios[[2]],".occupancy")]]==TRUE,]),
    row.names(pos_false_table[[7]]$false_peaks[pos_false_table[[7]]$false_peaks$common_pval==TRUE &                                                
                                               pos_false_table[[7]]$false_peaks[[paste0(trios[[2]],".occupancy")]]==TRUE &
                                               pos_false_table[[7]]$false_peaks[[paste0(trios[[3]],".occupancy")]]==FALSE,])),
  fn_40=intersect(
    row.names(pos_false_table[[4]]$false_peaks[pos_false_table[[4]]$false_peaks$common_pval==TRUE &                                              
                                               pos_false_table[[4]]$false_peaks[[paste0(trios[[1]],".occupancy")]]==FALSE & 
                                               pos_false_table[[4]]$false_peaks[[paste0(trios[[3]],".occupancy")]]==TRUE,]),
    row.names(pos_false_table[[7]]$false_peaks[pos_false_table[[7]]$false_peaks$common_pval==TRUE &                                                
                                               pos_false_table[[7]]$false_peaks[[paste0(trios[[2]],".occupancy")]]==FALSE & 
                                               pos_false_table[[7]]$false_peaks[[paste0(trios[[3]],".occupancy")]]==TRUE,])))

### Duplicate the peaks
# 4116 peaks are constant and were supposed to be unique for PAIRS of cell lines
id_constant_hichip_by_manorm_peaks_pairs=unique(unlist(hichip_fn_ids[1:3]))
# 5357 peaks are constant and were supposed to be unique for cell lines
id_constant_hichip_by_manorm_peaks_single_lines=unique(unlist(hichip_fn_ids[4:6]))

constant_hichip_by_manorm_peaks=norm_hichip[c(id_constant_hichip_by_manorm_peaks_pairs, 
                                              id_constant_hichip_by_manorm_peaks_single_lines),]

# constant_hichip_by_manorm_peaks$by_spp=FALSE
# constant_hichip_by_manorm_peaks$by_manorm=TRUE

constant_hichip_by_manorm_peaks.gr=sort(GRanges(constant_hichip_by_manorm_peaks))

# 4763 of 9473 are overlaping with ChIP-Seq
subsetByOverlaps(constant_hichip_by_manorm_peaks.gr, true_common_peaks_ChIPSeq$constant_peaks)
# 1075 of 9473 are actually overlaping with SPP detected peaks, but for some reason had false occupancy
subsetByOverlaps(constant_hichip_by_manorm_peaks.gr, true_common_peaks_HiChIP$constant_peaks)
# That's why we want to reduce these peaks. In total we have 30677 peaks, after reduction 29600 (2 more peaks were detected as overlapped)
hichip_constant_peaks_with_manorm=IRanges::reduce(c(constant_hichip_by_manorm_peaks.gr, true_common_peaks_HiChIP$constant_peaks))

# Let's do the overlap of all true peaks with ChIP-Seq constant peaks
# 22022 from 29600 were overlapped (before only 18122, so +3900 new peaks), ChIP-Seq have 37332 peaks. 
subsetByOverlaps(hichip_constant_peaks_with_manorm, true_common_peaks_ChIPSeq$constant_peaks)


```
# [ChIA-PET 2 rep] MANorm data processing
```{r}
experiment="chiapet"
cell_lines=c("GM19238_rep1", "GM19238_rep2", "GM19239_rep1", "GM19239_rep2","GM19240_rep1","GM19240_rep2")
trios=c("GM19238", "GM19239", "GM19240")

norm_inp_chiapet_2rep=data.frame(read.table(paste0("data/", experiment, "/chiapet_2rep_mrg_bins_profile_bins.xls"), header = T))

### Normalize between groups
norm_chiapet_2rep <- MAnorm2::normalize(norm_inp_chiapet_2rep, count = 4:5, occupancy = 10:11)
norm_chiapet_2rep <- MAnorm2::normalize(norm_chiapet_2rep, count = 6:7, occupancy = 12:13)
norm_chiapet_2rep <- MAnorm2::normalize(norm_chiapet_2rep, count = 8:9, occupancy = 14:15)

### Visualize the plots before/after normalization (Generating new plots and data (log2))
raw_chiapet_2rep = log(norm_inp_chiapet_2rep[4:9] + 0.5, base = 2)

png(paste0('ChIA-PET_MAnorm_2rep_normalization_mrgBins_y15.png'), res = 300, width = 4200, height = 4200)

# Generating new plots and data (log2)
set_ylim<<-c(-15, 15)
par(mar=c(3,3,3,3))
layout(matrix(c(1,2,3,4,5,6,1,7,3,8,5,9),ncol=2),heights=c(1,3,1,3,1,3))
plot.new()
text(0.5,0.5,trios[[1]],cex=3,font=2)
generate_manorm_plot(cell_lines[1:2], norm_chiapet_2rep, raw_chiapet_2rep)
plot.new()
text(0.5,0.5,trios[[1]],cex=3,font=2)
generate_manorm_plot(cell_lines[3:4], norm_chiapet_2rep, raw_chiapet_2rep)
plot.new()
text(0.5,0.5,trios[[1]],cex=3,font=2)
generate_manorm_plot(cell_lines[5:6], norm_chiapet_2rep , raw_chiapet_2rep)
#After normalization
generate_manorm_plot(cell_lines[1:2], norm_chiapet_2rep)
generate_manorm_plot(cell_lines[3:4], norm_chiapet_2rep)
generate_manorm_plot(cell_lines[5:6], norm_chiapet_2rep)
dev.off()

### Construct a bioCond for each group of samples.
conds_chiapet_2rep_raw <- list(
  GM19238 = bioCond(norm_chiapet_2rep[4:5], norm_chiapet_2rep[10:11], name = trios[[1]]),
  GM19239 = bioCond(norm_chiapet_2rep[6:7], norm_chiapet_2rep[12:13], name = trios[[2]]),
  GM19240 = bioCond(norm_chiapet_2rep[8:9], norm_chiapet_2rep[14:15], name = trios[[3]]))

### Perform between-group normalization.
autosome <- !(norm_inp_chiapet_2rep$chrom %in% c("chrX", "chrY"))
conds_chiapet_2rep <- normBioCond(conds_chiapet_2rep_raw, common.peak.regions = autosome)

# Drawing MA plots on bioCond objects to visualize the normalization results 

png(paste0('ChIA-PET_MAnorm_2rep_trios_normalization_mrgBins_y2.png'), res = 300, width = 4200, height = 4200)
set_ylim<<-c(-2, 2)

# Generating new plots and data (log2)
par(mar=c(3,3,3,3))
layout(matrix(c(1,2,3,4,5,6,1,7,3,8,5,9),ncol=2),heights=c(1,3,1,3,1,3))
plot.new()
text(0.5,0.5,paste0(trios[1]," vs. ", trios[2]),cex=3,font=2)
generate_manorm_plot_trios(trios[1:2], conds_chiapet_2rep_raw, "before")
plot.new()
text(0.5,0.5,paste0(trios[1]," vs. ", trios[3]),cex=3,font=2)
generate_manorm_plot_trios(trios[1:3], conds_chiapet_2rep_raw, "before")
plot.new()
text(0.5,0.5,paste0(trios[2]," vs. ", trios[3]),cex=3,font=2)
generate_manorm_plot_trios(trios[2:3], conds_chiapet_2rep_raw, "before")
#After normalization
generate_manorm_plot_trios(trios[1:2], conds_chiapet_2rep, "after")
generate_manorm_plot_trios(trios[1:3], conds_chiapet_2rep, "after")
generate_manorm_plot_trios(trios[2:3], conds_chiapet_2rep, "after")
dev.off()

### Fit an MVC.
conds_chiapet_2rep <- fitMeanVarCurve(conds_chiapet_2rep, 
                                     method = "parametric", 
                                     occupy.only = TRUE,
                                     init.coef = c(0.1, 10))
### Plot only occupied genomic intervals,
# as only these intervals have been used to fit the MVC.
plotMeanVarCurve(conds_chiapet_2rep, subset = "occupied", ylim = c(-7, 0.5))

### Perform differential tests.
res_chiapet_rep2=list(all_trios=aovBioCond(conds_chiapet_2rep),
                     diffTest(conds_chiapet_2rep[[1]], conds_chiapet_2rep[[2]]),
                     diffTest(conds_chiapet_2rep[[1]], conds_chiapet_2rep[[3]]),
                     diffTest(conds_chiapet_2rep[[2]], conds_chiapet_2rep[[3]]))
names(res_chiapet_rep2)=c("all_trios", 
                              paste0(trios[1],"_",trios[2]),
                              paste0(trios[1],"_",trios[3]), 
                              paste0(trios[2],"_",trios[3]))

# Visualize the results

png(paste0('ChIA-PET_MAnorm_2rep_trios_diff_test_mrgBins_pval_0.05.png'), res = 300, width = 2200, height = 2200)
par(mar=c(2.3,2.3,2.3,2.3))
layout(matrix(c(1,2,3,4,1,5,3,4,1,6,3,4),ncol=3),heights=c(1,3,1,3,1,3))

plot.new()
text(0.5,0.5,"Within paris of trios ",cex=3,font=2)
MAplot(res_chiapet_rep2$GM19238_GM19239, pval = 0.05, ylim = c(-2, 2), main=paste0(trios[1]," vs. ", trios[2]), line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
plot.new()
text(0.5,0.5,"Within all trios ",cex=3,font=2)
plot(res_chiapet_rep2$all_trios, pval = 0.05,line=0.2)
MAplot(res_chiapet_rep2$GM19238_GM19240, pval = 0.05,ylim = c(-2, 2), main=paste0(trios[1]," vs. ", trios[3]), line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
MAplot(res_chiapet_rep2$GM19239_GM19240, pval = 0.05,ylim = c(-2, 2), main=paste0(trios[2]," vs. ", trios[3]),line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
dev.off()

```

# [ChIA-PET 2 rep] Analysis of the results
```{r}
experiment="ChIA-PET"

# Create tables that will include all important information for the analysis
common_chiapet_manorm_2rep=list(
  create_table_common_peaks_with_info(norm_chiapet_2rep, res_chiapet_rep2, conds_chiapet_2rep, trios[1:2]),
  create_table_common_peaks_with_info(norm_chiapet_2rep, res_chiapet_rep2, conds_chiapet_2rep, trios[c(1:3)]),
  create_table_common_peaks_with_info(norm_chiapet_2rep, res_chiapet_rep2, conds_chiapet_2rep, trios[2:3]))
names(common_chiapet_manorm_2rep)=create_short_name_for_col(trios)

# Create additional tables with lower and higher values of mean values (select the squares)
mean_range=c(10,10)

common_chiapet_manorm_2rep=add_greater_and_lower_mean_ranges_tables(common_chiapet_manorm_2rep, mean_range, trios[1:2])
common_chiapet_manorm_2rep=add_greater_and_lower_mean_ranges_tables(common_chiapet_manorm_2rep, mean_range, trios[c(1,3)])
common_chiapet_manorm_2rep=add_greater_and_lower_mean_ranges_tables(common_chiapet_manorm_2rep, mean_range, trios[2:3])

# Create false pos tables                                    
par="isPval"
prefix="_mrgBins_"
pos_false_tables_chiapet_2rep=list(
  create_fp_tables_and_save_graphs(common_chiapet_manorm_2rep[[1]],trios[1:2], experiment, paste0("all",prefix),par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm_2rep[[4]],trios[1:2], experiment, paste0("mean>=10",prefix), par),      
  create_fp_tables_and_save_graphs(common_chiapet_manorm_2rep[[5]],trios[1:2], experiment, paste0("mean<10",prefix), par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm_2rep[[2]],trios[c(1,3)], experiment, paste0("all",prefix), par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm_2rep[[6]],trios[c(1,3)], experiment, paste0("mean>=10",prefix), par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm_2rep[[7]],trios[c(1,3)], experiment, paste0("mean<10",prefix), par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm_2rep[[3]],trios[2:3], experiment, paste0("all",prefix), par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm_2rep[[8]],trios[2:3], experiment, paste0("mean>=10",prefix), par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm_2rep[[9]],trios[2:3], experiment, paste0("mean<10",prefix), par))
names(pos_false_tables_chiapet_2rep)=names(common_chiapet_manorm_2rep)[c(1,4,5,2,6,7,3,8,9)]
rm(prefix)

# Create confusion tables         
confusion_tables_chiapet=vector(mode="list", length=NROW(pos_false_tables_chiapet_2rep))
names(confusion_tables_chiapet)=names(pos_false_tables_chiapet_2rep)
for (i in 1:NROW(confusion_tables_chiapet)){
  confusion_tables_chiapet[i]=list(caret::confusionMatrix(factor(common_chiapet_manorm_2rep[[names(confusion_tables_chiapet)[i]]]$common_pval, levels=c(TRUE, FALSE)), 
                       factor(common_chiapet_manorm_2rep[[names(confusion_tables_chiapet)[i]]]$predicted_rev, levels=c(TRUE, FALSE)),
                       dnn=c("pval>0.05", "SPP_detected")))
}


# 4 CASES
# Both show common (TP)
confusion_data_chiapet_2rep=list(
  list(TP=pos_false_tables_chiapet_2rep[[1]][[1]][pos_false_tables_chiapet_2rep[[1]][[1]]$common_pval==TRUE,],
       # Spp pokazuje tak, a padj pokazuje róźną siłę (FP)
       FP=pos_false_tables_chiapet_2rep[[1]][[1]][pos_false_tables_chiapet_2rep[[1]][[1]]$common_pval==FALSE,], 
       # SPP pokazuje nie, a padj pokazuje, że siła jest taka sama (FN)
       FN=pos_false_tables_chiapet_2rep[[1]][["false_peaks"]][pos_false_tables_chiapet_2rep[[1]][["false_peaks"]]$common_pval==TRUE,],
       # SPP pokazuje nie i padj się zgadza  (TN)
       TN=pos_false_tables_chiapet_2rep[[1]][["false_peaks"]][pos_false_tables_chiapet_2rep[[1]][["false_peaks"]]$common_pval==FALSE,]),
  list(TP=pos_false_tables_chiapet_2rep[[4]][[1]][pos_false_tables_chiapet_2rep[[4]][[1]]$common_pval==TRUE,],
       
       # Spp pokazuje tak, a padj pokazuje róźną siłę (FP)
       FP=pos_false_tables_chiapet_2rep[[4]][[1]][pos_false_tables_chiapet_2rep[[4]][[1]]$common_pval==FALSE,],
       # SPP pokazuje nie, a padj pokazuje, że siła jest taka sama (FN)
       FN=pos_false_tables_chiapet_2rep[[4]][["false_peaks"]][pos_false_tables_chiapet_2rep[[4]][["false_peaks"]]$common_pval==TRUE,],
       # SPP pokazuje nie i padj się zgadza  (TN)
       TN=pos_false_tables_chiapet_2rep[[4]][["false_peaks"]][pos_false_tables_chiapet_2rep[[4]][["false_peaks"]]$common_pval==FALSE,]),
  
  list(TP=pos_false_tables_chiapet_2rep[[7]][[1]][pos_false_tables_chiapet_2rep[[7]][[1]]$common_pval==TRUE,],
       # Spp pokazuje tak, a padj pokazuje róźną siłę (FP)
       FP=pos_false_tables_chiapet_2rep[[7]][[1]][pos_false_tables_chiapet_2rep[[7]][[1]]$common_pval==FALSE,],
       # SPP pokazuje nie, a padj pokazuje, że siła jest taka sama (FN)
       FN=pos_false_tables_chiapet_2rep[[7]][["false_peaks"]][pos_false_tables_chiapet_2rep[[7]][["false_peaks"]]$common_pval==TRUE,],
       # SPP pokazuje nie i padj się zgadza  (TN)
       TN=pos_false_tables_chiapet_2rep[[7]][["false_peaks"]][pos_false_tables_chiapet_2rep[[7]][["false_peaks"]]$common_pval==FALSE,]))

names(confusion_data_chiapet_2rep)=names(common_chiapet_manorm_2rep)[1:3]

```


# [ChIA-PET merged] MANorm input

```{r}
# Name of the experiment is being used during the saving of the plots
experiment="ChIA-PET"
# trios names are being used to name the components in the list
trios=c("GM19238", "GM19239", "GM19240")
# read the input file for MANorm (generated from MANorm_utils)
norm_inp_chiapet=data.frame(read.table(paste0("data/chiapet/chiapet_merged_profile_bins.xls"), header = T))

# See how many TRUE/FALSE peaks are present for each cell line for the occupancy calculated by MANorms
table_chiapet_occupancy_raw=list(
  summary(as.logical(norm_inp_chiapet$GM19238.occupancy)),
  summary(as.logical(norm_inp_chiapet$GM19239.occupancy)),
  summary(as.logical(norm_inp_chiapet$GM19240.occupancy)))
names(table_chiapet_occupancy_raw)=trios

# Replace the occupancy by occupancy calculated from overlapping with bins
occupancy_by_overlaps_chiapet=list()
for (cell_line in trios){
  occupancy_by_overlaps_chiapet[[cell_line]]=as.integer(1:NROW(chiapet_bins) %in% unique(queryHits(findOverlaps(chiapet_bins,peaks_with_motif_ChIAPET[[cell_line]]))))
}

norm_inp_chiapet$GM19238.occupancy=occupancy_by_overlaps_chiapet$GM19238
norm_inp_chiapet$GM19239.occupancy=occupancy_by_overlaps_chiapet$GM19239
norm_inp_chiapet$GM19240.occupancy=occupancy_by_overlaps_chiapet$GM19240

# See how many TRUE/FALSE peaks are present for each cell line for the occupancy calculated by overlapping
table_chiapet_occupancy_overlapped=list(
  summary(as.logical(norm_inp_chiapet$GM19238.occupancy)),
  summary(as.logical(norm_inp_chiapet$GM19239.occupancy)),
  summary(as.logical(norm_inp_chiapet$GM19240.occupancy)))
names(table_chiapet_occupancy_overlapped)=trios

```

# [ChIA-PET merged] MANorm normalization
```{r}

### Visualize the plots before/after normalization (log2)
raw_chiapet = log(norm_inp_chiapet[4:6] + 0.5, base = 2)

### Normalize between cell lines
autosome <- !(norm_inp_chiapet$chrom %in% c("chrX", "chrY"))
norm_chiapet <- normalize(norm_inp_chiapet, c(4:6), c(7:9), common.peak.regions = autosome)
norm_chiapet$index=row.names(norm_chiapet)

png(paste0('plots/',experiment,'_MAnorm_merRep_normalization_overlaps.png'), res = 300, width = 4200, height = 4200)

# Generation of new plots before/after normalization (log2)
set_ylim<<-c(-2,2)
par(mar=c(3,3,3,3))
layout(matrix(c(1,2,3,4,5,6,1,7,3,8,5,9),ncol=2),heights=c(1,3,1,3,1,3))
plot.new()
text(0.5,0.5,paste0(trios[1],' vs. ', trios[2]),cex=3,font=2)
generate_manorm_plot(trios[1:2], norm_chiapet, raw_chiapet)
plot.new()
text(0.5,0.5,paste0(trios[1],' vs. ', trios[3]),cex=3,font=2)
generate_manorm_plot(trios[c(1,3)], norm_chiapet, raw_chiapet)
plot.new()
text(0.5,0.5,paste0(trios[2],' vs. ', trios[3]),cex=3,font=2)
generate_manorm_plot(trios[2:3], norm_chiapet , raw_chiapet)
#After normalization
generate_manorm_plot(trios[1:2], norm_chiapet)
generate_manorm_plot(trios[c(1,3)], norm_chiapet)
generate_manorm_plot(trios[2:3], norm_chiapet)
dev.off()
```

#[ChIA-PET merged] Modeling of Mean-Variance Trend

```{r}
### Construct a bioCond for each group of samples.
conds_chiapet <- list(
  bioCond(norm_chiapet[4], norm_chiapet[7], name = trios[1]),
  bioCond(norm_chiapet[5], norm_chiapet[8], name = trios[2]),
  bioCond(norm_chiapet[6], norm_chiapet[9], name = trios[3]))
names(conds_chiapet)=trios

### Create a "blind" biocond, that will treat two samples as replicates.
# Only common peak regions of the two samples are considered to the occupied by the "Blind" bioCond

conds_chiapet$blind_1 <- bioCond(norm_chiapet[c(4, 5)], norm_chiapet[c(7, 8)], occupy.num = 2)
conds_chiapet$blind_2 <- bioCond(norm_chiapet[c(4, 6)], norm_chiapet[c(7, 9)], occupy.num = 2)
conds_chiapet$blind_3 <- bioCond(norm_chiapet[c(5, 6)], norm_chiapet[c(8, 9)], occupy.num = 2)
conds_chiapet$blind_common <- bioCond(norm_chiapet[c(4, 5, 6)], norm_chiapet[c(7, 8, 9)], occupy.num = 3)

names(conds_chiapet)[4:7]=c(paste0("blind_", trios[1],"_",trios[2]), 
                           paste0("blind_", trios[1],"_",trios[3]),
                           paste0("blind_", trios[2],"_",trios[3]),
                           "blind_common")

conds_chiapet_meanCurve=list(fitMeanVarCurve(conds_chiapet[c(1, 2, 3, 7)], method = "parametric",
                         occupy.only = TRUE, init.coef = c(0.1, 10)),
                            fitMeanVarCurve(conds_chiapet[c(1, 2, 4)], method = "parametric",
                         occupy.only = TRUE, init.coef = c(0.1, 10)),
                            fitMeanVarCurve(conds_chiapet[c(1, 3, 5)], method = "parametric",
                         occupy.only = TRUE, init.coef = c(0.1, 10)),
                            fitMeanVarCurve(conds_chiapet[c(2, 3, 6)], method = "parametric",
                         occupy.only = TRUE, init.coef = c(0.1, 10)))
names(conds_chiapet_meanCurve)=c("all_trios", 
                                 paste0(trios[1],"_",trios[2]),
                                 paste0(trios[1],"_",trios[3]), 
                                 paste0(trios[2],"_",trios[3]))

# Visualize mean-variance trend along with the fitted MVC. Plots are not being saved
plotMeanVarCurve(conds_chiapet_meanCurve[[2]][3], subset = "occupied", ylim = c(-7, 1))
plotMeanVarCurve(conds_chiapet_meanCurve[[3]][3], subset = "occupied", ylim = c(-7, 1))
plotMeanVarCurve(conds_chiapet_meanCurve[[4]][3], subset = "occupied", ylim = c(-7, 1))
plotMeanVarCurve(conds_chiapet_meanCurve$all_trios[4], subset = "occupied", ylim = c(-7, 1))

```

# [ChIA-PET merged] Differential Tests

```{r}

### # Perform differential tests
res_chiapet=list(
  aovBioCond(conds_chiapet_meanCurve[[1]]),
  diffTest(conds_chiapet_meanCurve[[2]][[1]], conds_chiapet_meanCurve[[2]][[2]]),
  diffTest(conds_chiapet_meanCurve[[3]][[1]], conds_chiapet_meanCurve[[3]][[2]]),
  diffTest(conds_chiapet_meanCurve[[4]][[1]], conds_chiapet_meanCurve[[4]][[2]]))
names(res_chiapet)=names(conds_chiapet_meanCurve)

# Visualize the results
p_value<<- 0.05

png(paste0('plots/',experiment,'_MAnorm_merRep_trios_diff_test_pval_',p_value,'_overlaps.png'), res = 300, width = 2200, height = 2200)
par(mar=c(2.3,2.3,2.3,2.3))
layout(matrix(c(1,2,3,4,1,5,3,4,1,6,3,4),ncol=3),heights=c(1,3,1,3,1,3))

plot.new()
text(0.5,0.5,"Within paris of trios ",cex=3,font=2)
MAplot(res_chiapet[[2]], pval = p_value, ylim = c(-2, 2), main=paste0(trios[1]," vs. ",trios[2]), line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
plot.new()
text(0.5,0.5,"Within all trios ",cex=3,font=2)
plot(res_chiapet[[1]], pval = p_value,line=0.2)
MAplot(res_chiapet[[3]], pval = p_value,ylim = c(-2, 2), main=paste0(trios[1]," vs. ",trios[3]), line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
MAplot(res_chiapet[[4]], pval = p_value,ylim = c(-2, 2), main=paste0(trios[2]," vs. ",trios[3]),line=0.2)
abline(h = 0, lwd = 2, lty = 5, col = "green3")
dev.off()

```

#[ChIA-PET merged] Differential Tests - statistical power of identifying differential genomic intervals for merged and single replicates

```{r}

#Define the correlation between single and merged replicates
correaltion_chiapet_mer_vs_2rep=c()
for (name in names(res_chiapet)){
  correaltion_chiapet_mer_vs_2rep[[name]]=cor(res_chiapet_rep2[[name]]$pval, res_chiapet[[name]]$pval, method = "spearman")
}

png(paste0('plots/',experiment,'_correlation_pval_single_merged.png'), res = 300, width = 2200, height = 1100)
layout(matrix(c(1,3,7,2,4,8,2,5,9,2,6,10),ncol=4),heights=c(1,3,0.5,1,3,0.5,1,3,0.5,1,3,0.5), widths=c(2, 1.5, 1.5, 1.5))

par(mar=c(0,0,0,0))
plot.new()
text(0.5,0.5,"All trios",cex=1.5,font=2)
plot.new()
text(0.5,0.5,"Within pairs of trios",cex=1.5,font=2)

par(mar=c(4,4,1,0.5))
plot(-log10(res_chiapet_rep2[[1]]$pval), -log10(res_chiapet[[1]]$pval), col = "#0000FF14", pch = 20, xlab = "With Reps", ylab = "Without Reps")
plot(-log10(res_chiapet_rep2[[2]]$pval), -log10(res_chiapet[[2]]$pval), col = "#0000FF14", pch = 20, xlab = "With Reps", ylab = "Without Reps", main=names(res_chiapet_rep2)[[2]])
plot(-log10(res_chiapet_rep2[[3]]$pval), -log10(res_chiapet[[3]]$pval), col = "#0000FF14", pch = 20, xlab = "With Reps", ylab = "Without Reps", main=names(res_chiapet_rep2)[[3]])
plot(-log10(res_chiapet_rep2[[4]]$pval), -log10(res_chiapet[[4]]$pval), col = "#0000FF14", pch = 20, xlab = "With Reps", ylab = "Without Reps", main=names(res_chiapet_rep2)[[4]])

par(mar=c(0,0,0,0))
plot.new()
text(0.66, 0.66,paste0("cor = ",round(correaltion_chiapet_mer_vs_2rep[[1]],2)),cex=1,font=2)
plot.new()
text(0.66, 0.66,paste0("cor = ",round(correaltion_chiapet_mer_vs_2rep[[2]],2)),cex=1,font=2)
plot.new()
text(0.66, 0.66,paste0("cor = ",round(correaltion_chiapet_mer_vs_2rep[[3]],2)),cex=1,font=2)
plot.new()
text(0.66, 0.66,paste0("cor = ",round(correaltion_chiapet_mer_vs_2rep[[4]],2)),cex=1,font=2)

```

# [ChIA-PET merged] Analysis of the results: Show which peaks were filtered by pval based on their mean_value
```{r}
experiment="ChIA-PET"

# Create tables that will include all important information for the analysis
common_chiapet_manorm=list(
  create_table_common_peaks_with_info(norm_chiapet, res_chiapet, conds_chiapet, trios[1:2]),
  create_table_common_peaks_with_info(norm_chiapet, res_chiapet, conds_chiapet,trios[c(1,3)]),
  create_table_common_peaks_with_info(norm_chiapet, res_chiapet, conds_chiapet, trios[2:3]))
names(common_chiapet_manorm)=create_short_name_for_col(trios)

# Create additional tables with lower and higher values of mean values (select the squares)
mean_cutoff=10

common_chiapet_manorm=add_greater_and_lower_mean_ranges_tables(common_chiapet_manorm, mean_cutoff, trios[1:2])
common_chiapet_manorm=add_greater_and_lower_mean_ranges_tables(common_chiapet_manorm, mean_cutoff, trios[c(1,3)])
common_chiapet_manorm=add_greater_and_lower_mean_ranges_tables(common_chiapet_manorm, mean_cutoff, trios[2:3])

# Create tables and graphs that will show which mean values have cell lines and their pval
par="isPval"

pos_false_tables_chiapet=list(
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[1]],trios[1:2], experiment, "all_mrgRep", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[4]],trios[1:2], experiment, "mean>=10_mrgRep", par),      
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[5]],trios[1:2], experiment, "mean<10_mrgRep", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[2]],trios[c(1,3)], experiment, "all_mrgBins", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[6]],trios[c(1,3)], experiment, "mean>=10_mrgRep", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[7]],trios[c(1,3)], experiment, "mean<10_mrgRep", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[3]],trios[2:3], experiment, "all_mrgRep", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[8]],trios[2:3], experiment, "mean>=10_mrgRep", par),
  create_fp_tables_and_save_graphs(common_chiapet_manorm[[9]],trios[2:3], experiment, "mean<10_mrgRep", par))

names(pos_false_tables_chiapet)=names(common_chiapet_manorm)[c(1,4,5,2,6,7,3,8,9)]

```

[ChIA-PET merged] Confusion matrices

```{r}
# List that contains filtered peaks (wout sex chromosomes and peaks that are coming from 3 cell line) 
# They are being used to create confusion matrices
peaks_excl_3_cell_line_and_sex_chr=vector(mode = "list", length = 9)
names(peaks_excl_3_cell_line_and_sex_chr)=names(pos_false_tables_chiapet)

n=cell1=1
cell2=2

for (pair in names(peaks_excl_3_cell_line_and_sex_chr)){
  tmp1=anti_join(common_chiapet_manorm[[pair]], 
                 common_chiapet_manorm[[pair]][common_chiapet_manorm[[pair]]$chrom=="chrX" |
                                               common_chiapet_manorm[[pair]]$chrom=="chrY",])
  tmp1=anti_join(tmp1, tmp1[tmp1[[paste0(trios[cell1],".occupancy")]]==0 & 
                         tmp1[[paste0(trios[cell2],".occupancy")]]==0,])
  n=n+1
  if (n==4){cell2=cell2+1}
  if (n==7){cell1=cell1+1}
  
  peaks_excl_3_cell_line_and_sex_chr[[pair]]=tmp1
  rm(tmp1)
}
rm(cell1, cell2, n, pair)

# Create confusion tables for every pairs of replicates and greater and lower ranges                  
confusion_tables_chiapet=vector(mode="list", length=NROW(peaks_excl_3_cell_line_and_sex_chr))
names(confusion_tables_chiapet)=names(peaks_excl_3_cell_line_and_sex_chr)

for (i in 1:NROW(confusion_tables_chiapet)){
  confusion_tables_chiapet[i]=list(caret::confusionMatrix(factor(peaks_excl_3_cell_line_and_sex_chr[[names(confusion_tables_chiapet)[i]]]$common_pval, levels=c(TRUE, FALSE)), 
                       factor(peaks_excl_3_cell_line_and_sex_chr[[names(confusion_tables_chiapet)[i]]]$predicted_rev, levels=c(TRUE, FALSE)),
                       dnn=c(paste0("pval>",p_value), "SPP_detected")))
}

# Table that are lying under the confusion matrices (TP, TN, FP, FN)
# 4 CASES
confusion_data_chiapet=vector(mode="list", length=3)
names(confusion_data_chiapet)=create_short_name_for_col(trios)

cell1=n=1
cell2=2
for (pair in names(confusion_data_chiapet)){
  confusion_data_chiapet[[pair]]=
    # Both show common (TP)
    list(
      TP=peaks_excl_3_cell_line_and_sex_chr[[pair]][peaks_excl_3_cell_line_and_sex_chr[[pair]]$common_pval==TRUE &
                                                      peaks_excl_3_cell_line_and_sex_chr[[pair]][[paste0(trios[cell1], ".occupancy")]]==1 &
                                                      peaks_excl_3_cell_line_and_sex_chr[[pair]][[paste0(trios[cell2], ".occupancy")]]==1,],
      # Spp shows yes, but pval shows different strength (FP)
      FP=peaks_excl_3_cell_line_and_sex_chr[[pair]][peaks_excl_3_cell_line_and_sex_chr[[pair]]$common_pval==FALSE &
                                                      peaks_excl_3_cell_line_and_sex_chr[[pair]][[paste0(trios[cell1], ".occupancy")]]==1 &
                                                      peaks_excl_3_cell_line_and_sex_chr[[pair]][[paste0(trios[cell2], ".occupancy")]]==1,],
      # SPP shows no, but pval shows, że siła jest taka sama (FN)
      FN=peaks_excl_3_cell_line_and_sex_chr[[pair]][peaks_excl_3_cell_line_and_sex_chr[[pair]]$common_pval==TRUE &
                                                      (peaks_excl_3_cell_line_and_sex_chr[[pair]][[paste0(trios[cell1], ".occupancy")]]==0 |
                                                      peaks_excl_3_cell_line_and_sex_chr[[pair]][[paste0(trios[cell2], ".occupancy")]]==0),],
       # SPP shows no and manorm agrees (TN)
       TN=peaks_excl_3_cell_line_and_sex_chr[[pair]][peaks_excl_3_cell_line_and_sex_chr[[pair]]$common_pval==FALSE &
                                                      (peaks_excl_3_cell_line_and_sex_chr[[pair]][[paste0(trios[cell1], ".occupancy")]]==0 |
                                                      peaks_excl_3_cell_line_and_sex_chr[[pair]][[paste0(trios[cell2], ".occupancy")]]==0),])
    n=n+1
    if(n==2){cell2=cell2+1}
    if(n==3){cell1=cell1+1}
}
rm(cell1, cell2, n, pair)

```

[ChIA-PET merged] Select possible constant peaks
```{r}

confusion_data=confusion_data_chiapet

chiapet_fn_ids=list(
  
  ### PAIRS of cell lines ###
  
  # Probable constant peaks are those, in which peaks for 2 cell lines are TP, and for the third line FN
  # For examples, if GM38_GM39 are TP (by SPP and pval) and GM38_GM40 are negative (by SPP), 
  # but positive by pval (>(0.05)) than those peaks are considered to be constant
  
# Results
  # Between 38_39 and 40 --> + 3510
  # Between 38_40 and 39 --> + 2362
  # Between 39_40 and 38 --> + 3805
  
  fn_38_39=intersect(
    confusion_data$GM38_GM39$TP$norm.index,
    unique(confusion_data$GM38_GM40$FN[confusion_data$GM38_GM40$FN$GM19240.occupancy==FALSE,]$norm.index,
           confusion_data$GM39_GM40$FN[confusion_data$GM39_GM40$FN$GM19240.occupancy==FALSE,]$norm.index)),
  fn_38_40=intersect(
    confusion_data$GM38_GM40$TP$norm.index,
    unique(confusion_data$GM38_GM39$FN[confusion_data$GM38_GM39$FN$GM19239.occupancy==FALSE,]$norm.index,
           confusion_data$GM39_GM40$FN[confusion_data$GM39_GM40$FN$GM19239.occupancy==FALSE,]$norm.index)),
  fn_39_40=intersect(
    confusion_data$GM39_GM40$TP$norm.index,
    unique(confusion_data$GM38_GM39$FN[confusion_data$GM38_GM39$FN$GM19238.occupancy==FALSE,]$norm.index,
           confusion_data$GM38_GM40$FN[confusion_data$GM38_GM40$FN$GM19238.occupancy==FALSE,]$norm.index)),
  
  ### SINGLE CELL LINE ###
  
  # Peaks were 
  
  # Probable constant peaks are those, in which peaks for 2 cell lines are TP, and for the third line FN
  # For examples, if GM38_GM39 are TP (by SPP and pval) and GM38_GM40 are negative (by SPP), 
  # but positive by pval (>(0.05)) than those peaks are considered to be constant
  
# Results
  # Between 38 and other cell_lines --> 8647 vs 9996 >> 6077 common
  # Between 39 and other cell_lines --> 7773 vs 6897 >> 3548 common
  # Between 40 and other cell_lines --> 4770 vs 3701 >> 1174 common
  
  fn_38=intersect(
    confusion_data$GM38_GM39$FN[confusion_data$GM38_GM39$FN$GM19238.occupancy==TRUE,]$norm.index,
    confusion_data$GM38_GM40$FN[confusion_data$GM38_GM40$FN$GM19238.occupancy==TRUE,]$norm.index),

  fn_39=intersect(
    confusion_data$GM38_GM39$FN[confusion_data$GM38_GM39$FN$GM19239.occupancy==TRUE,]$norm.index,
    confusion_data$GM39_GM40$FN[confusion_data$GM39_GM40$FN$GM19239.occupancy==TRUE,]$norm.index),

  fn_40=intersect(
    confusion_data$GM38_GM40$FN[confusion_data$GM38_GM40$FN$GM19240.occupancy==TRUE,]$norm.index,
    confusion_data$GM39_GM40$FN[confusion_data$GM39_GM40$FN$GM19240.occupancy==TRUE,]$norm.index))

### Deduplicate the peaks
# 8928 peaks are constant and were supposed to be unique for PAIRS of cell lines
id_constant_chiapet_by_manorm_peaks_pairs=unique(unlist(chiapet_fn_ids[1:3]))
# 10405 peaks are constant and were supposed to be unique for cell lines
id_constant_chiapet_by_manorm_peaks_single_lines=unique(unlist(chiapet_fn_ids[4:6]))

# Get peaks using their indexes
# 19333 of possible unique peaks
constant_chiapet_by_manorm_peaks=norm_chiapet[sort(c(id_constant_chiapet_by_manorm_peaks_pairs, 
                                              id_constant_chiapet_by_manorm_peaks_single_lines)),]

constant_chiapet_by_manorm_peaks.gr=sort(GRanges(constant_chiapet_by_manorm_peaks))

### Overlapping pf the peaks
# 8625 of 19333 are overlaping with ChIP-Seq constant peaks
subsetByOverlaps(constant_chiapet_by_manorm_peaks.gr, true_common_peaks_ChIPSeq$constant_peaks)

# 2652 of 17686 are actually overlaping with SPP detected peaks, 
# but for some reason had false occupancy (some of them are narrow)
subsetByOverlaps(constant_chiapet_by_manorm_peaks.gr, true_common_peaks_ChIAPET$constant_peaks)

# That's why we want to reduce these peaks. In total we have 39031 (19333+19698) peaks, 
# after reduction 36379 (so minus overlapped peaks 2652)
chiapet_constant_peaks_with_manorm=IRanges::reduce(c(constant_chiapet_by_manorm_peaks.gr, true_common_peaks_ChIAPET$constant_peaks))

# How many initial peaks from ChIA-PET are overlapping with ChIP-Seq constant peaks
# 15600
subsetByOverlaps(true_common_peaks_ChIAPET$constant_peaks, true_common_peaks_ChIPSeq$constant_peaks)


# Let's do the overlap of all true peaks with ChIP-Seq constant peaks
# 22212 from 36379 were overlapped (before only 15600, so +6612 new peaks), ChIP-Seq has 37332 peaks. 
subsetByOverlaps(chiapet_constant_peaks_with_manorm, true_common_peaks_ChIPSeq$constant_peaks)

# Check which new peaks were being  ADDITIONALY detected by manorm
subsetByOverlaps(chiapet_constant_peaks_with_manorm, true_common_peaks_ChIPSeq$constant_peaks, invert=TRUE)

```

Rest of the script
```{r}
# Check which  false peaks have big pval 
hichip_gm38T_gm40F=common_hichip.gm38_g40[common_hichip.gm38_g40$GM19238.occupancy==FALSE & 
                       common_hichip.gm38_g40$GM19240.occupancy==TRUE & 
                         common_hichip.gm38_g40$pval<0.001,]

common_chiapet.gm38_g40$isPval=ifelse(gm38_39_df$padj<0.001, TRUE, FALSE)
ggplot(common_chiapet.gm38_g39, aes(x=GM19238.mean, y=GM19239.mean))+geom_point(aes(col=isPval))+geom_smooth(method="lm", formula=y~x)

# Chech why false peaks have big pval
constant_df=data.frame(chrom=norm_hichip_2rep$chrom,
           start=norm_hichip_2rep$start,
           end=norm_hichip_2rep$end,
           res_hichip_rep2,
           conds_hichip_2rep$GM19238$norm.signal,
           conds_hichip_2rep$GM19239$norm.signal,
           conds_hichip_2rep$GM19240$norm.signal,
           conds_hichip_2rep$GM19238$occupancy,
           conds_hichip_2rep$GM19239$occupancy,
           conds_hichip_2rep$GM19240$occupancy)

constant_hichip_false=constant_df[which(constant_df$conds_hichip_2rep.GM19238.occupancy==FALSE & 
                       constant_df$conds_hichip_2rep.GM19239.occupancy==FALSE& 
                         constant_df$conds_hichip_2rep.GM19240.occupancy==TRUE & 
                         constant_df$padj>0.01),]
constant_hichip_false[sort(constant_hichip_false$pval, index.return=T,decreasing = TRUE)$ix,][1:10,]






# cos=norm_chiapet_eden_single_simple[which(norm_chiapet_eden_single_simple$GM19238.occupancy==1),]
norm_inp_hichip_2rep[sort(res_hichip_rep2$pval, index.return=T)$ix,]
norm_hichip_2rep[sort(res_hichip_rep2$pval, index.return=T)$ix,]

unique_38_39_hichip=which(norm_hichip_2rep$GM19238_rep1.occupancy==1 & 
                                             norm_hichip_2rep$GM19238_rep2.occupancy==1&
                                             norm_hichip_2rep$GM19239_rep1.occupancy==1 &
                                             norm_hichip_2rep$GM19239_rep2.occupancy==1)
norm_inp_hichip_2rep[unique_38_39_hichip,][sort(res_hichip_rep2[unique_38_39_hichip,]$pval, index.return=T)$ix,]
head(norm_inp_hichip_2rep[unique_38_39_hichip,][sort(res_hichip_rep2[unique_38_39_hichip,]$pval, index.return=T)$ix,])

norm_inp_hichip_2rep[sort(res_hichip_rep2_38_39[]$pval, index.return=T)$ix,]
norm_hichip_2rep[sort(res_hichip_rep2_38_39$pval, index.return=T)$ix,]




```
##### Identifying Hypervariable ChIP-seq Signals
```{r}
autosome <- !(norm_inp_hichip_2rep$chrom %in% c("chrX", "chrY"))
hyper_norm_hichip_2rep <- normalize(norm_inp_hichip_2rep, count = 4:9, occupancy = 10:15,
                  baseline = "pseudo-reference",
                  common.peak.regions = autosome)

# Construct a bioCond to group all the samples.
hyper_conds_hichip_2rep <- bioCond(hyper_norm_hichip_2rep[4:9], 
                                   hyper_norm_hichip_2rep[10:15], 
                                   occupy.num = 1,
                                   name = "all")

# Fit an MVC by using local regression.
# Set "nn = 1" to increase the smoothness of the resulting MVC.
hyper_conds_hichip_2rep <- fitMeanVarCurve(list(hyper_conds_hichip_2rep), method = "local",
                        occupy.only = TRUE, args.lp = list(nn = 1))[[1]]
summary(hyper_conds_hichip_2rep)

# Apply the parameter estimation framework of HyperChIP.(dramatic increase in the estimated number of prior degrees of freedom)
hyper_conds_hichip_2rep <- estParamHyperChIP(hyper_conds_hichip_2rep)
summary(hyper_conds_hichip_2rep)

# Perform statistical tests.
hyper_res_hichip_rep2 <- varTestBioCond(hyper_conds_hichip_2rep)
head(hyper_res_hichip_rep2)

# Visualize the overall test results.
hist(hyper_res_hichip_rep2$pval, breaks = 100, col = "red")
plot(hyper_res_hichip_rep2, padj = 0.01)

# one-sided p-values for identifying hypervariable ChIP-seq signals
df <- attr(hyper_res_hichip_rep2, "df")
one.sided.pval <- pf(hyper_res_hichip_rep2$fold.change, df[1], df[2], lower.tail = FALSE)

n <- rowSums(hyper_norm_hichip_2rep[10:15])
x <- list(All = -log10(one.sided.pval[n == 5]),
          Partially = -log10(one.sided.pval[n > 0 & n < 5]))
wilcox.test(x$All, x$Partially, alternative = "less")

boxplot(x, ylab = "-Log10(p-value)")
boxplot(x, ylab = "-Log10(p-value)", outline = FALSE)

# Measure the distance between each pair of samples.
d <- distBioCond(hyper_conds_hichip_2rep, method = "prior")

# Perform hierarchical clustering.
plot(hclust(d, method = "average"), hang = -1)

# Select hypervariable genomic intervals.
f <- hyper_res_hichip_rep2$fold.change > 1 & hyper_res_hichip_rep2$padj < 0.01
d2 <- distBioCond(hyper_conds_hichip_2rep, subset = f, method = "prior")
plot(hclust(d2, method = "average"), hang = -1)
```










